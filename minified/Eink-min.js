class Eink{mainBook=void 0;manual=void 0;controlPanel=void 0;mode="scroll";lang="zh-TW";isEinkDevice=!1;inIOSBrowser=void 0;preventGestures=!1;#e=0;#t=0;#o=!0;#n=[];#i=[];#s=void 0;#r=[];#a=[];#l=[];#h=[];#c=0;#d=0;#g=10;#u=0;#m=null;#p=!1;#k=null;#b=null;#f=null;#v=300;#y=0;#w=!1;#T="\n  html {\n    touch-action: pan-y pinch-zoom !important;\n  }\n\n  #einkBtn {\n    margin:0px !important;\n    padding: 2px !important;\n    font: 12px Roboto, sans-serif !important;\n    font-weight: bold !important;\n    float: right;\n    border: 1px solid red;\n    border-radius: 40% !important;\n  }\n\n  .inactiveBtn {\n    opacity: 0.5;\n  }\n\n  .activeBtn {\n    box-shadow: 1px 2px 2px gray;\n  }\n\n  .activeBtn:hover,\n  .activeBtn:focus {\n    color: blue;\n    text-decoration: none;\n    cursor: pointer;\n  }\n\n  .noteBook .highlight-title {\n    border-radius: 10px;\n    margin-left: -10px;\n    padding-left: 10px;\n  }\n\n  .noteBook {\n    font-size: 18px;\n    line-height: 1.5;\n  }\n\n  .noteBook li {\n    margin: 10px 0px;\n  }\n\n  .noteBook h1, .noteBook h2, .noteBook h3, .noteBook h4 {\n    margin:20px 0px;\n  }\n\n  .noteBook img, .noteBook iframe {\n    vertical-align: top;\n    max-width: 100%;\n    max-height: 100%;\n    height: auto;\n    width: auto;\n  }\n\n  .noteBook .web-address {\n    font-size: 12px;\n  }\n\n  .disable-default-touch {\n    touch-action: none !important;\n  }\n\n  .modal {\n    display: none;\n    position: fixed;\n    z-index: 99999;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0,0,0,0.4);\n  }\n  \n  .modal-content {\n    position: absolute;\n    background-color: #fefefe;\n    padding: 20px;\n    border: 1px solid #888;\n    width: 300px;\n    text-align: center;\n    border-radius: 5px;\n    box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n    box-sizing: border-box;\n  }\n  \n  .modal-content p {\n    margin-bottom: 20px;\n  }\n  \n  .modal-content button {\n    margin: 0 10px;\n    padding: 10px 20px;\n    border: none;\n    border-radius: 3px;\n    cursor: pointer;\n  }\n  \n  #confirmYes {\n    background-color: #4CAF50;\n    color: white;\n  }\n  \n  #confirmNo {\n    background-color: #f44336;\n    color: white;\n  }\n\n  .draw {\n    position: absolute;\n    left: 0px;\n  }\n\n  .floatToolBar {\n    position: fixed;\n    display: flex;\n    flex-direction: column;\n    justify-content: space-around;\n    right: 5%;\n    z-index: 9999;\n  }\n\n  .toolDiv img {\n    border-radius: 100%;\n    border: 1px solid red;\n    pointer-events: none;\n    width: 38px;\n  }\n\n  .toolDiv div {\n    width: 40px;\n    height: 40px;\n    border-radius: 100%;\n  }\n\n  .toolDiv {\n    display: flex;\n    background-color: white;\n    border-radius: 100%;\n  }\n\n  #picViewer {\n    position: fixed;\n    top: 0px;\n    left: 0px;\n    z-index: 500;\n    background-color: white;\n    display: none;\n    width: 100%;\n    height: 100%;\n  }\n\n  #detailView {\n    position: relative;\n    border-bottom: 5px solid red;\n    overflow: hidden;\n  }\n\n  #overview {\n    position: relative;\n  }\n\n  #magnifier {\n    position: absolute;\n    border: 1px solid white;\n  }\n\n  #closeViewer {\n    position: absolute;\n    right: 5px;\n    top: 5px;\n    width: 20px;\n    line-height: initial;\n    text-align: center;\n    z-index: 100;\n    background-color: white;\n    border: 1px solid yellow;\n  }\n\n  #closeViewer:focus,\n  #closeViewer:hover {\n    color: blue;\n    cursor: pointer;\n  }\n\n  greenmark {\n    background-color: rgba(0, 255, 0, 0.33);\n  }\n\n  bluemark {\n    background-color: rgba(0, 0, 255, 0.33);\n  }\n\n  redmark {\n    background-color: rgba(255, 0, 0, 0.33);\n  }\n";onEnterEink=()=>{};onEnterScroll=()=>{};onSwitchMode=()=>{};onenterhighlight=()=>{};onexithighlight=()=>{};onenterdraw=()=>{};onexitdraw=()=>{};manualItems=[{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjYk8GwZ8PYK8HySK5f9odf9KFtjvO0FF7EtDCjyGZH68UOozlax5tp9enYlmyy5zuKjB4s4aS7gG0EuaqG1D42giRmaY8wjFefjAEqy25AVbQfA2goWECkOkwEsAYxq6h_CbF4FmgPv9eH66rfw-kYS0HQSiLkmPPY_YjPfCZqNvqxLbQEXqIuQ92K/s1600/My%20Icons.001.jpeg",text_ch:"上下頁",text_en:"Prev/Next page"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhXkkLY_Fa4L9o0mihyphenhyphentMn9Vh2zg4DHxhv4sWE5Xn87-I4oOapZaOSgplqj-3QMN32otIXxTGPa1MSF64t92rn8XrAeZYYEPZTN_Ce1vLxHZsn3wILu1e5mYYVWp6EmMN96Ikn4O5uGFrXDUNlm37giUwcHNt11GedxgaptzRdRZHs8mcZ2UMmPxuVW/s1600/My%20Icons.002.jpeg",text_ch:"跳至頁首或頁尾",text_en:"First/Last page"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTczCkhjunJZ-YYzFqM5lfMvple9hOcbV-kq9TYXc42xlXwjlA39UAcDhicKyBJHliWLXu990ZuF1Wu9_f8sd_BTWe5sWscAsrt-_q0nbGlivKbPxHCKbhL2CVmnxoCXlHszAY77MjNGWVt2R6hfRMf_m4SZ4LL3nfInIRcYpeDX39PNawQTy2y2kX/s1600/My%20Icons.003.jpeg",text_ch:"跳至目錄",text_en:"Content Table"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhLUDauFfSLelk-D3iw1w0WhRK5xITT39qhz4lvMSLVYO51telsPREjLsvn15lObbgh_0WIwaFJ1vAZ-PGpfa2yD1krwcfPNKFKAESPI41ii-MB5Us5HcKwUQzjzAieaSU-8CSxHvSsrp9w2WXica1B7V3Y35TWYGt5A4F4VXaYRwXBzzMqeKLLbox5/s1600/My%20Icons.006.jpeg",text_ch:"功能選單",text_en:"Tool menu"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhYAIeHUu4pp_wj5pNkqkUzeSWqeSEphV2oVFHSAqvmLcY6bowCX0Elkbf3D9ZiOlFusHk_Dgc1S0YXJLANIQDf_-RyCcGKmzLH_mU_o2aANS7P753SiqEf7drhk30s-WqoUcshwKO8jvbNrBow6SCQ1pVQlhzUmGBy-YcAMFcIZKEVyY4A6WtH4ZoW/s1600/My%20Icons.005.jpeg",text_ch:"螢光筆工具",text_en:"Highlighting tools"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhu1U1dTJNXOIt18alwwMVzDFN_vQn9y-_rztf0nHk_mzx4QVKaJ6n3BgxF8r4MAgk5TjEFqNPpC_KSnWxz8JmSmqj0jOjRrqTfReZoPWf4vQ2O0Vtt3DFddhfXzYa_L-G_h4gARFzVOzJ9PLBWZsHj0XQRBrNVyBxDZMXP7Hp5P_o5mT7g6_ie8Xcc/s1600/My%20Icons.004.jpeg",text_ch:"繪圖工具",text_en:"Drawing tools"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhRehc5pJOlN5BFufdPdefTQJY56I1FqgwTRvsPToiuE_trB1tfmf9rlwpeMianuy9L9vzVzKtqm-cWqgayMwTOQ1BOXTsK2XIuZa1VfjBy654KNPeiE4HnQRxLS4bhY-sPgAkkuoUTOog8WMctdNmh0gvRhyTwhwtMgp4cCbE-sMCWrvLBHfX9gxSH/s1600/My%20Icons.007.jpeg",text_ch:"回滾動瀏覽",text_en:"Enter scroll mode"},{imgSrc:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiHQnh2Mws6rKlrgqjijo9TRU0AJMBrM5W238if9z6hox_j_x1iBSDP_5DwSN61Csh_JY2jRifm8jxePqNgIfLkz441EXJuFJualCb-4uj0Hnz6PXIFWwDOptOaWxYFY-xKyx1TYRji4umD7sF-qzaD_xvp5PMqE37ZjNMBWkbANU6gXcc5p3BhM_gV/s1600/My%20Icons.008.jpeg",text_ch:"支援藍芽翻頁器",text_en:"Page turner support"}];toolBarIconSrc={info_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgP18Ftd5a_6yfz1gKM7GhcZ_8_rdvxZndC_ovXMxGX4i7SpNMJK8qQdlEjoXMTReGfgc6K6Y8sQkHfXO4-4Bjvb2PxyavybuynaHx1jdBThyr11dwWL32tFoztv3TblpMvkeASTEsUyLr9zXjW7Ig7yMGv1SwslB2Vy10DPtXsm6BCIUDZsbli3IJ7/s1600/My%20Icons5.001.png",exit_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJqJfPLeoAgrJhcKsizMtPgBFKF8QTH7gGehvI2HUVIfcM60YbrhxpkU19DLFTx9VbMGALhm9B0hRFxj214f8uzR__oDGCOnzjeumHDTjsI03RL7H073mVUCppp7O0_EzJICF8tdgeLrynGoX44uyYk34i0btTP9feWsIPHEXesgUyHvdwspixs49t/s1600/My%20Icons4.001.png",selection_erase:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiJk_5KhyL_DilHxz5jPaIQG1A4PyBmoZFso7DDUkGrByAW1S-3nQhXiZz9_XcK5v7jdkoq4lD-F32ZgjI6CK-QEHf70OtxWGgAf7prl5Ic03unI4s1W6CVAzot9ckPI20EWHZ_AHYfscDgrsrfIczaV0NJe4c8E2W-oCoqaxfDALSCfIUuanzkJVk3/s1600/My%20Icons3.004.png",printer:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtiFUtWjuIH3FVR4cngQDnCWwhpMORu3YH65mJF-bzeWgqAyGjALToAPI9YmFWBnrQgl4D0CGteZdBtwSRXcbxD4xzGg7vLqeS91tdodyW_Sn7oTP-TXuwvqlw6lNpKYpwgDjWbkCVrt36DMQ1AGP-WDGydAglMFtYd-5WFoAGaPoCGp-MiZ3yyYNm/s1600/My%20Icons3.003.png",scroll_mode:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhay__pRQG8aRwUI54PEwe9gSddm4yF7Uq-67TJml-R6scnopk3HEw6WQbEkC6KjsPybqd9OxM98-2InaW6OJRDJAZNuq1c6oha36RoTnmgdoB6LXclkWMBs22Yu4s2roGIrBMgUF4ITvUb0DbZ080yHz7Iisgstpyxg_5782fu3Idutlw40MbtxRFs/s1600/My%20Icons3.002.png",content_table:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjogD1ZGFzyRGEJCVabZB98KSIEQUPiD6eSTcSKH0MMB1edlvYSmv-4g-lpPk85XsMBBF3AMyPKVpgjrNecROrKyHuz5E5RXDgXk5uPVVOeRY0wJki2Fvwo5xV8RAAhRtR6WyTZ8WHY1lKIqZruCRzUB9A7MXV1bsGvwDXimQBJWcD3VGvcHagrOkcT/s1600/My%20Icons3.001.png",flip_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1kotoDrHoSmTW3hvvqdKo3k_f_3fV9P3jwgRb5ec-RbrY-lqd41PSxJzZdwcK2BO7HDAvGiIe7BzQ3NDXMmDhYgYB2NIrAU771yymFvxQWrbFInsOPtu93xJvmeNXq0EakCmKovtz0BcGeI4XbphxhzHpeO6hrOZDSu8tPfHPQJM723PkICc1wgev/s1600/My%20Icons.020.jpeg",eraser_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgU7tW-aiB4rFaDiSNz0q8dC-D6jNZFxqGVE-P3pcTWSt4opKQ0dmdMohk5OTZjjRGva-LW06grfMT37RHBQ3TkLEqtcgBwqSM3If9LsBCD_7jlSdM5MqSKKnhwTewMQeiWqaoge5slglV7RRZKhht9u-63FbTnBdfvQ41MeGzXLQAEOQmxQI6sg9c1/s1600/My%20Icons.008.jpeg",heavyLine_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZqSpDjs_uk160FGJryo69_QcEJCHfhxQXmW0h4UPpmzNssttKT448uYKAr7USzrT-nwx-5dOhWuDgn3u_Xcb96AADvuf9W4Yz1jq_NF75Vy3rJSo7WPAC3Edd2xIBKU5Dwzauo16MgrstlangVRA-lXkR-nrh_RK_0UMeZR813aQyg9GEpj7xltVJ/s1600/My%20Icons.015.jpeg",mediumLine_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQrdtp5hUWIUBUyuc2Y0WdzD37hR8NFAC6XG6PTqlcLUEqKgvckUZovBVMkAougZY_hru3Rika2KHXKly_ls7I2EA-GmDzFv8LAqkE9EwKd-y48cqFrMfNlE4nXC3rkTf60ZbYQnyrGnkqTpWIZIvkd7lSKSmDvsaaxGtIOckRTmcVPhqdrPoy9hGG/s1600/My%20Icons.014.jpeg",lightLine_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEinezMz8j9WXdWxXYR3ev5oPNXHCW2mcBI6yyYO2eofWus52XU_Mj5RRMZZ_xRco4x-JKGTTZkcbVOy71R5T2tWyL2H1CAByjqgwU149QSJ4fonaf11HKELg4b-zqvSDwOdS9hCiB4dCHK4_U0ws8FD4otugvpdBc_sMQePtrcrCbsooi1a1NPs0wZM/s100/My%20Icons.013.jpeg",pencil_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0l38bY6cQKWWmradQWMdqSt55uWbY6MZ0kM4ZmmFDRnQjLETvJwKR9Da2RxCE44MAI0m3Zl2GAj2njeLxP8gJYfyAUH_bWpgfuqy5DIEgOyz4ovUS3JVVFIaChpXE8yQ21k6M-FwySEZZNYO9WwjUoKgh3c0msCkJUKesbyvGUPsF72C12wj0MTnd/s1600/My%20Icons.005.jpeg",eraserActivated_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgsvPPvsXzWTvV7MmdfGbLU1439YX8DjB3Axei-wPY26DuGdtc2Q0XljyA8LjonIZvquqOxJWv8PIbN-qcDaC0zFxGKpE1POCVs-Cir_kXm7vfEnepBtdPh9PWIu2sdKp5CJBn4YVDD0w5VKMxxr_IiX5NPkjiN0jUeoP3MJ96gKfsRnFwe-HzcbFyS/s1600/My%20Icons.007.jpeg",pencilActivated_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgY5od-TTYNXaRAu-n9lDf1TPmZ-0PYDeB-VhciHTOM-JzK_oO7qRC9Kwyueaq3dg3oGtX8pUescVAWopLQ3FcvT8Gc0RcKXy7NfvpIo395d1cAJ_ThVxw8lBwlWRAKaO5Yq-Qz7VIt-58GmXdZjx1VjQebtYCsKvICIa0ZO1_FeXjVDighgF8jQgtd/s1600/My%20Icons.006.jpeg",greenMarkPen_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNOAtaDrDO6F1mBJZ5AF0foCHgbDe22SJdox6X_FK9CJ8lHOUPKTRX5h3tjpZCP-SwUaU7q2DLFofWtvgIHvtANp4wBI0kHSgW1g-MUW7V1GxCfPoar7qAz8ampfJDB9bJd5tWdDH_6BE9hyphenhyphenrEmF5KMnq0fnhnvCbp3zGRq7yNhDG20LAxUN9Uxv6A/s1600/My%20Icons.010.jpeg",blueMarkPen_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEimGCz8aeQmFpbyxuTYChl4HN_vSLepXG2ngl6AhrjgRlPL8ZtOiP35DKNwCqFiJoaPS92ut5QkWIBNxEVmMFadvfu83EXctRcn61P02to-SISW8O-4xKMBzwc016UcEqMbjrW9qRvob8WhyirBhHbga85RDW59zW7bmRGOpr2VKLzeksVKOwvuDvsW/s1600/My%20Icons.011.jpeg",redMarkPen_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhQXNCMDZlsUrYMwywsIsswJAqwU20EVpBvIa_gc_LypxaNSrVO51Uiqi_GlL26Llv8cQhSCzzTfpu9E8PN4I-MdVq01hg79kYArmUifgEC9N8XueQ0iMc-WSIRJezOMvQ_PgRgIJVfM2fkmDD9AaeJ61m1UsasZMspiwZMPx1qjnypB1sokcFjM2n/s1600/My%20Icons.009.jpeg",close_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqGBBfx8c5PnhZkJeAF678yHAWKxbIUtNDULXH0PAtAg7V3fxPFv7afUOaIEf0l0b3JEukZ-RlI8wfaBclSSEYRGonJbrL-kc8ANIDH9W_4bR3oQQS1RG6i8uAlBMNrMeTxldz_7sKydDFjOaH3h_R4Rp1wb9MjVBoKqD2fiivuNC3dUxoW4a2eWZv/s1600/My%20Icons.012.jpeg",nextPage_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7GTkmp8QveImSeIlK8DzRTd0SYWConssaCyeB7pUY1ugxoV0LhPjeGR5sF5juP8faOPkEL2SMs0LnaqSmhSV0QOn0R-tRbdM1HPcrOwi-WQb89BwGgybAw3IXLIuW-ZJLRvXNV4hnjsrubnfazhyukLwcdckOnzez0y5XvCXio0ekpSzlTNjQTK9r/s1600/My%20Icons.001.jpeg",prevPage_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgf4dLbiKEWds8l6agI7QWrp8epc16uUb7ext3FyJjhfcAlq6izeH93DCe-AArSfG3LKCGmRJkz8ZHDii_na1PcfcShsnBYfCUWWJe2UxFC59-W8bdk-iD0w8e68mCTAjmkJNLYGJ4JcLdjcAZxcF8mJZ6bS5qH40LaO7OomgDsG4FLp7R021k_kwAa/s1600/My%20Icons.002.jpeg",eraser_cursor:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipeXg__4_sCbV2dXUNojNHt1QX1SC-WiRcF0gEWwsu0ONRqgAT1oC9NqRU00TB0DS3vimHgYjzm4V-9R4X9__xRV0bRk5j1IwfPaFkmHyFH-Z2po49jS_NsaGTieTScUj7lA8dISWLp4j5ennGv_4xU_JdhgjjXdiqyIDNI7SRdv3aF7tuQYk8kpIU/s1600/My%20Icons1.011.png",noteBook_icon:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9f7nzG3Ajy-QmPAOYPxieJTpqG2NZI_ns6ff54xixHhTbWw53vy3cYi5V0qgx9UAtFC76Oeop7UATqio8miLJmbz8hNxNFB_W-ABtywizm2JJcenpfGENsCbnZtTMPqRjwpLYKedYyiCPZPhMJJK78lHWla5IBwglBBdc2gYGblGrpKVAiohyir9U/s1600/My%20Icons2.001.png",increaseText_disabled:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg0zCl1N4df27_Zu_FbmTehe474Z3p2tYf3Vl3AIqukijElJNIsCl6EnnSmRUwCTBnlbjNcrlNJBjzA2x22F_x6bb3CTDVc3hLMFncbG4reQ7mp8H8uvzLWBT3D9Wqq17VoSuAqEdm7hw/s200/Icons.002.png",increaseText_enabled:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGogFFCYWS2k_Hr2bYZQp3Vt36O-3kVUlnSK758Qon7mLhBpqADpL6h16B7ZU8r1u906cXMl4PGwyVyvMIVbmWTZSFy_9Oe4PFdgq6IAeQsYWGR9d2bC5gcpAsOcLTmk6TmE8Fq3roWg/s200/Icons.001.png",decreaseText_disabled:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgigG2M2hO3UhFmHW0lMuqcJWp1xLA_PUqS5mBu1V0_45jUjEuBEmiXQMLwxqcQKbVVdRKLa88_ixO5ObMwj0_TitNM3-doOmbwH8sQcXud-24zHEKEqdA6l9nSyJ4mG5deegiImMi0Vw/s320/Icons.004.png",decreaseText_enabled:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhDkiKmL3wwNJSXW4lPrAa9xJSLkKR68Lf9qxxu5_S_Z0wwIkkNwH0XY2mH_CL6S5fuQDwVudm7BrZ0y8KSKzYNOAPD4FC_OfjA7m2wiDSobwBRLpHuR1KAHlB9ghljP-vGnv-muujwcw/s200/Icons.003.png"};autoLeave=!1;autoEnter=!1;einkStyle="";constructor(e={}){if(e={...{lang:void 0,mainBook:void 0,einkStyle:"",autoEnter:!1,autoLeave:!1},...e},Book.prototype.bookConfig.allowDraw=!0,Book.prototype.bookConfig.allowHighlight=!0,e.lang?this.lang=e.lang:document.documentElement.lang.includes("zh")?this.lang="zh-TW":this.lang="en",this.#x(),this.#r.forEach((e=>{$(e).addClass("bookContents")})),this.#l.forEach((e=>{$(e).addClass("bookItem")})),this.#a.forEach((e=>{$(e).addClass("bookUI")})),e.mainBook)this.mainBook=e.mainBook;else if(this.#s){const e=$(this.#s[0])[0];e&&(this.mainBook=this.createBook(e,this.#s[1]))}this.mainBook||(this.mainBook=new Book(document.body)),this.#i.forEach((([e,t])=>{const o=$(e)[0];o&&this.createBook(o,t)})),this.mainBook.eink=this,this.floatToolBar.book=this.mainBook,this.autoLeave=e.autoLeave,this.autoEnter=e.autoEnter,this.einkStyle+=e.einkStyle,this.inIOSBrowser=(()=>{const e=navigator.userAgent||navigator.vendor||window.opera;return!(!/iPad|iPhone|iPod/.test(e)||window.MSStream)||!(!/Mac/.test(e)||e.includes("Chrome"))})()}createBook(e,t){const o={};return Object.keys(Book.prototype.bookConfig).forEach((e=>{const n=t.style.getPropertyValue(`--${e}`);n&&(["fullScreen","allowDraw","allowHighlight","useNotes"].includes(e)?o[e]="true"===n.trim():["upperMargin","lowerMargin","leftMargin","rightMargin","zIndex","minImgHeight"].includes(e)?o[e]=parseInt(n,10):o[e]=n.trim())})),void 0===o.lang&&(o.lang=this.lang),new Book(e,o)}init(){this.setupEinkStyle(),this.#B(),document.documentElement.classList.add("limit-default-touch"),this.autoLeave&&(this.mainBook.onBookEnd=()=>{this.enterScrollMode()}),this.#C(this.lang).then((()=>{this.#I(),$(window).on("keydown",this.#E.bind(this)),this.setupEinkBtn("fixed"),this.autoEnter?"eink"===sessionStorage.mode?this.enterEinkMode():sessionStorage.mode="scroll":(sessionStorage.mode="scroll",this.books.forEach((e=>{sessionStorage.setItem("pageNumBook"+e.instanceID,"")})))}))}get noteBook(){return $(".noteBook")[0]}get bookContainers(){return[...$(".book").filter(((e,t)=>void 0!==t.book))]}get bookContents(){return this.books.map((e=>e.contents))}get books(){return this.bookContainers.map((e=>e.book)).sort(((e,t)=>t.instanceID-e.instanceID))}static getIconImg(e,t){const o=document.getElementById(e).cloneNode(!0);return o.removeAttribute("id"),t&&(o.id=t),o}#I(){const e=e=>t=>{this.#w||e.call(this,t)};$(window).on("pointerdown.eink",e(this.#S)),$(window).on("pointermove.eink",e(this.#M)),$(window).on("pointerup.eink pointercancel.eink",e(this.#P)),$(window).on("keyup.eink",e(this.#R)),$(window).on("beforeunload.eink",e(this.#W))}#L(){$(window).off(".eink")}#A(){$(window).on("beforeprint.print",(()=>{this.enterPrintMode()})),$(window).on("afterprint.print",(()=>{this.exitPrintMode()}))}exitPrintMode(){this.#w||Book.focusedBook.exitPrintMode()}enterPrintMode(){if(!this.#w){const e=Book.focusedBook;this.setupEinkStyle(`\n          @page {\n            size: ${e.pageWidth+2*e.bookConfig.leftMargin}px ${e.pageHeight+e.bookConfig.upperMargin+e.bookConfig.lowerMargin}px; \n            margin-top: 0px;\n            margin-bottom: 0px;\n            margin-left: 0px;\n            margin-right: 0px;\n          }\n        `,!1),"eink.draw"===this.mode?this.floatToolBar.exitDraw():"eink.highlight"===this.mode&&this.floatToolBar.exitHighlight(),$(".floatToolBar, .manual, .controlPanel").hide(),e.enterPrintMode()}}enterEinkMode(){this.manual.show(),this.mode="eink.read",sessionStorage.mode="eink",this.setupEinkStyle(),$("#einkBtn").hide(),document.getElementById("controlPanel")||this.setupControl(),"complete"!==document.readyState&&($("#highlightMode, #draw, #noteBook, #printMode").each(((e,t)=>{t.onclick=()=>{this.notReady()},t.classList.add("inactiveBtn")})),$(window).on("load",(()=>{this.setupControl()}))),document.documentElement.classList.add("disable-default-touch"),this.#A(),new Promise((e=>{this.books.forEach((e=>{e.enterEinkMode(),e.addEventListener("pagechange",(()=>{$(e.container).find(".draw").hide(),$("#"+this.painter.getCanvasId(e)).show()})),e.addEventListener("bookresize",(()=>{$(e.container).find(".draw").hide()})),e.addEventListener("bookreset",(()=>{$(e.container).find(".draw").hide(),$("#"+this.painter.getCanvasId(e)).show(),this.floatToolBar?.submenuOn&&this.floatToolBar?.toggleSubmenu(),this.floatToolBar.repositionFloatToolBar()})),$("#"+this.painter.getCanvasId(e)).show(),"complete"!==document.readyState&&(e.ignoreMutation=!0,document.addEventListener("load",(()=>{e.ignoreMutation=!1})))})),e()})).then((()=>{this.manual.ready(),this.onEnterEink({books:this.books}),this.onSwitchMode({mode:"eink.read",books:this.books})}))}#x(){const e={book:(e,t)=>{e.forEach((e=>{const o=this.#i.findIndex((([t])=>t===e));-1!==o?this.#i[o][1]=t:this.#i.push([e,t])}))},mainBook:(e,t)=>{this.#s=[e[0],t]},"book-content":e=>this.#r.push(...e),"book-item":e=>this.#l.push(...e),"book-UI":e=>this.#a.push(...e)};for(let t=0;t<document.styleSheets.length;t++)try{const o=document.styleSheets[t];for(let t=0;t<o.cssRules.length;t++){const n=o.cssRules[t];if(n.media&&"eink"===n.media.mediaText){this.#h.push(n);for(let t=0;t<n.cssRules.length;t++){const o=n.cssRules[t];if(this.einkStyle+=o.cssText+"\n",o.style){const t=o.style.getPropertyValue("--display");if(t&&e[t]){const n=o.selectorText.split(",").map((e=>e.trim()));e[t](n,o)}}}}}}catch(e){}}#W(e){e.preventDefault(),this.mode.startsWith("eink")&&("eink.notebook"===this.mode?this.highlighter.hideNoteBook():"note"===Book.focusedBook.container.id&&Book.focusedBook.hideNoteWindow())}#E(e){if("Escape"!==e.key||"none"===$("#controlPanel").css("display"))if("eink.read"===this.mode){if(!this.#f&&e.ctrlKey?(this.#f=e.key,setTimeout((()=>{this.#f=null}),1e3)):e.altKey?this.setCursorImage("eraser"):"Escape"===e.key&&(Book.focusedBook===this.mainBook?this.enterScrollMode():"note"===Book.focusedBook.container.id&&Book.focusedBook.hideNoteWindow()),"Control"===this.#f)switch(e.key){case"1":this.#_("rgb(0, 255, 0)");break;case"2":this.#_("rgb(0, 0, 255)");break;case"3":this.#_("rgb(255, 0, 0)");break;case"n":this.highlighter.showNoteBook();break;case"c":this.checkContent()}}else"eink.notebook"===this.mode?"Escape"===e.key&&this.highlighter.hideNoteBook():"eink.draw"===this.mode?"Escape"===e.key&&this.floatToolBar.exitDraw():"eink.highlight"===this.mode&&"Escape"===e.key&&this.floatToolBar.exitHighlight();else $("#controlPanel").hide()}#R(e){"Alt"===e.key&&this.setCursorImage("default")}#_(e){this.highlighter.highlightColor=e}#D(){return new Promise((e=>{let t=0,o=performance.now();const n=()=>{const e=performance.now();if(t++,e-o>=1e3){Math.round(1e3*t/(e-o));t=0,o=e,requestAnimationFrame(n)}else requestAnimationFrame(n)};requestAnimationFrame(n)}))}setCursorImage(e){const t={highlight:'url("path/to/highlight-cursor.png") 0 20, auto',draw:'url("path/to/draw-cursor.png") 0 20, auto',eraser:`url(${this.toolBarIconSrc.eraser_cursor}) 0 20, auto`,default:"default"};document.body.style.cursor=t[e]||t.default}#B(){const e=document.createElement("div");e.id="iconImgDive",e.classList.add("eink"),Object.entries(this.toolBarIconSrc).forEach((([t,o])=>{const n=document.createElement("img");n.src=o,n.id=t,e.appendChild(n)})),this.manualItems.forEach(((t,o)=>{const n=document.createElement("img");n.src=t.imgSrc,n.id="manualIcon"+o,e.appendChild(n)})),document.documentElement.appendChild(e),e.style.display="none"}setupEinkStyle(e="",t=!0){let o=document.getElementById("einkStyleSheet");o||(o=document.createElement("style"),o.id="einkStyleSheet",document.head.appendChild(o)),this.mode.includes("eink")?t?(this.einkStyle+=e,o.textContent=this.einkStyle+this.#T):o.textContent=this.einkStyle+this.#T+e:t?(this.#T+=e,o.textContent=this.#T+e):o.textContent=this.#T+e}removeEinkStyle(){const e=document.getElementById("einkStyleSheet");e&&(e.textContent=this.#T)}#S(e){if("touch"===e.pointerType)this.#n.push(e),1===this.#n.length&&(this.#e=e.clientX,this.#t=e.clientY),"eink.read"===this.mode&&2===this.#n.length&&(this.#u=this.#X(this.#n[0],this.#n[1])),this.#y=this.#n.length;else if("mouse"===e.pointerType)"eink.read"!==this.mode&&"scroll"!==this.mode||(1!==e.buttons||e.metaKey||e.altKey?1===e.buttons&&(e.metaKey||e.altKey)&&(this.highlighter.enterHighlightMode(this.bookContents),$(this.floatToolBar.view).hide(),$(Book.focusedBook.contents).trigger(e),Book.focusedBook.contents.setPointerCapture(e.pointerId)):this.#b=setTimeout((()=>{"eink.read"===this.mode?this.showControlPanel():this.enterEinkMode()}),this.#v));else if("pen"===e.pointerType&&"eink.read"===this.mode){if("complete"!==document.readyState)return;this.manual.hide(),$("#controlPanel").hide(),this.painter.enterDrawMode(),$("#floatToolBar").hide();const t=document.elementFromPoint(e.clientX,e.clientY);$(t).trigger("pointerdown",{target:t,pointerType:"pen",pointerId:e.pointerId,clientX:e.clientX,clientY:e.clientY,buttons:e.buttons,button:e.button,stopPropagation:()=>{}}),t.setPointerCapture(e.pointerId)}}#M(e){if("eink.read"===this.mode&&"touch"===e.pointerType&&!this.preventGestures&&2===this.#y){const t=this.#n.findIndex((t=>t.pointerId===e.pointerId));-1!==t&&(this.#n[t]=e);const o=this.#X(this.#n[0],this.#n[1]),n=o-this.#u,i=30;Math.abs(n)>i&&(this.#o?(n>0?this.#H(e):this.#j(e),this.#u=o,this.#N(n>0)):this.#F())}"mouse"===e.pointerType&&1===e.buttons&&(clearTimeout(this.#b),"eink"===sessionStorage.mode&&(this.#p=!0))}#P(e){if("touch"===e.pointerType){if(1===this.#y){if(!0===this.preventGestures)return;if(this.preventGestures)return void this.preventGestures--;const t=e.clientX,o=e.clientY,n=t-this.#e,i=o-this.#t,s=50,r=window.innerWidth,a=window.innerHeight;if("scroll"===sessionStorage.mode)Math.abs(i)<s&&n>s&&(this.manual.load(),this.enterEinkMode());else if("eink.notebook"===this.mode)Math.abs(i)<s&&n<-s?this.highlighter.hideNoteBook():Math.abs(i)<s&&n>s&&this.showControlPanel();else{const e=this.#e>3*r/4&&this.#t<a/4,t=this.#e<r/4&&this.#t<a/4,o=this.#e>3*r/4&&this.#t>3*a/4,l=this.#e<r/4&&this.#t>3*a/4,h=this.#e>r/4&&this.#e<3*r/4&&this.#t>a/4&&this.#t<3*a/4;if(e&&n<-s&&i>s)this.painter.enterDrawMode();else if(t&&n>s&&i>s)this.highlighter.enterHighlightMode(this.bookContents);else if(l&&n>s&&i<-s){const e=this.mainBook.findContTablePage();e&&(this.mainBook.currentPage=e)}else h&&n<-s&&i>s?Book.focusedBook.exitPrintMode():o&&n<s&&i<-s?this.highlighter.showNoteBook():Math.abs(i)<s&&n>s?this.showControlPanel():Math.abs(i)<s&&n<-s&&this.enterScrollMode()}}else 2===this.#y&&this.previewBook&&this.#z();this.#n=[],this.#e=null,this.#t=null,this.#u=0,this.#y=0}else if("mouse"===e.pointerType&&(clearTimeout(this.#b),"eink"===sessionStorage.mode&&this.#p)){const{clientX:t,clientY:o}=e,n=document.elementFromPoint(t,o)?.closest(".book")?.book;n&&(n.preventFlip=1),this.#p=!1}}#X(e,t){const o=e.clientX-t.clientX,n=e.clientY-t.clientY;return Math.sqrt(o*o+n*n)}showControlPanel(){$("#controlPanel").show()}setupEinkBtn(e={}){const t={position:"static",top:"30px",left:"0px",right:"30px",bottom:"0px"};e={...t,...e};let o=document.getElementsByClassName("einkBtn")[0],n=document.getElementById("einkBtn");n||(n=document.createElement("div"),n.setAttribute("id","einkBtn"),n.classList.add("bookUI"),n.classList.add("inactiveBtn"),n.innerHTML="<b style='color:Blue'>e</b><b style='color:red'>ink</b>",this.inIOSBrowser&&"complete"!==document.readyState?$(window).on("load",(()=>{n.classList.add("activeBtn"),n.classList.remove("inactiveBtn"),n.onclick=e=>{this.enterEinkMode()}})):(n.classList.add("activeBtn"),n.classList.remove("inactiveBtn"),n.onclick=e=>{this.enterEinkMode()})),o?($(n).css("position","static"),o.appendChild(n)):(document.documentElement.append(n),$(n).css({...t,width:"fit-content",height:"fit-content","z-index":99999}))}#C(e="zh-TW"){const t=()=>{const t=document.getElementById("manualBox"),o=t.querySelector("table"),n=t.querySelector("h3");o.innerHTML="";const i=window.innerWidth>window.innerHeight;this.manual.isLandscape=i,i?function(e,t,o="zh-TW"){const n="zh-TW"===o?"text_ch":"text_en";for(let o=0;o<Math.ceil(t.length)/2;o++){const i=document.createElement("tr");for(let e=1;e<=4;e++){const s=Math.ceil((4*o+e)/2)-1;if(s<t.length){const o=document.createElement("td"),r=t[s],a=document.getElementById("manualIcon"+s).cloneNode(!0);e%2==1?o.appendChild(a):o.innerHTML=`        \n              <div><b>${r[n]}</b></div>\n          `,i.appendChild(o)}}e.appendChild(i)}}(o,this.manualItems,e):function(e,t,o="zh-TW"){const n="zh-TW"===o?"text_ch":"text_en";t.forEach(((t,o)=>{const i=document.createElement("tr"),s=document.createElement("td"),r=document.createElement("td"),a=document.getElementById("manualIcon"+o).cloneNode(!0);s.appendChild(a),r.innerHTML="<b>"+t[n]+"</b>",i.appendChild(s),i.appendChild(r),e.appendChild(i)}))}(o,this.manualItems,e);const s=t.clientHeight-n.offsetHeight-60-20;o.style.height=`${s}px`,function(e,t){const o=e.rows.length,n=t/o;Array.from(e.rows).forEach((e=>{e.style.height=`${n}px`;e.querySelectorAll("img").forEach((e=>{e.style.height=n-10+"px",e.style.width="auto",e.style.objectFit="contain"}))}))}(o,s)};return new Promise((o=>{if(!this.manual){const o=document.createElement("DIV"),n="zh-TW"===e?"進入Eink模式":"Enter Eink mode";!function(){const e=document.createElement("style");e.id="manualStylesheet",e.textContent="\n      #manual {\n        position: fixed;\n        top: 0;\n        left: 0;\n        z-index: 5000;\n        width: 100%;\n        height: 100%;\n        overflow: hidden;\n        background-color: rgba(0, 0, 0, 0.4);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        display:none;\n      }\n  \n  \n    #manualBox {\n      background-color: #fefefe;\n      border: 1px dotted red;\n      height: 90%;\n      max-width: 1000px;\n      width: 90%;\n      padding: 0px 30px;\n      border-radius: 20px;\n      box-sizing: border-box;\n      overflow: hidden;\n    }\n  \n    #manualBox table {\n        margin: 0px auto;\n        margin-bottom: 10px;\n    }\n  \n    #manualBox table td {\n        vertical-align: middle;\n        padding: 0 10px;\n    }\n    #manualBox table td:nth-child(2) {\n        position: relative;\n        top: -10px;\n    }\n  \n    #manualBox button {\n        float: right;\n        margin-right: 10px;\n        margin-bottom: 10px;\n    }\n  \n    #closeManual {\n        float: right;\n        font-size: 30px;\n        margin-top: 20px;\n        color: blue;\n    }\n\n    #loadingText {\n      float: right;\n      margin-top: 20px;\n      font-size: 12px;\n      color: #888;\n    }\n\n    #closeManual:hover,\n    #closeManual:focus {\n        color: blue;\n        text-decoration: none;\n        cursor: pointer;\n    }\n      ",document.head.appendChild(e)}(),o.setAttribute("id","manual"),o.classList.add("eink"),o.innerHTML=`\n          <div id="manualBox">\n            <span id="closeManual" style="display: none;">×</span>\n            <span id="loadingText">Loading...</span>\n            <h3>${n}</h3>\n            <table></table>\n          </div>`,o.show=()=>{o.style.display="flex",t()},o.hide=()=>{o.style.display="none"},o.load=()=>{$("manual").off("click.manual"),$("#closeManual").hide(),$("#loadingText").show()},o.ready=()=>{$("#closeManual").show(),$("#loadingText").hide(),$("#manual").on("click.manual",(function(e){e.stopPropagation(),this.hide()}))},document.documentElement.append(o),this.manual=o}this.manual.load();const n=this.manualItems.map(((e,t)=>new Promise((o=>{const n=new Image;n.onload=()=>o(),n.src=e.imgSrc,n.id="manualIcon"+t}))));Promise.all(n).then((()=>{t(),$(window).on("resize.manual",(()=>{this.manual.isLandscape!==window.innerWidth>window.innerHeight&&t()})),o()}))}))}async customConfirm(e,t=30,o=150){let n=document.getElementById("customConfirm");return n||(n=document.createElement("DIV"),n.id="customConfirm",n.classList.add("modal"),n.innerHTML='\n      <div class="modal-content">\n      <p>Join highlights on the previous page?</p>\n      <button id="confirmYes">Yes</button>\n      <button id="confirmNo">No</button>\n      </div>\n      ',document.documentElement.append(n)),new Promise((i=>{const s=n.querySelector("p"),r=n.querySelector(".modal-content");void 0!==t&&"default"!==t||(t=(window.innerWidth-300)/2),r.style.top=`${o}px`,r.style.left=`${t}px`,s.textContent=e,n.style.display="block";const a=document.getElementById("confirmYes"),l=document.getElementById("confirmNo");function h(e){n.style.display="none",i(e)}a.onclick=()=>h(!0),l.onclick=()=>h(!1)}))}setupControl(e=[],t=3){let o;o=document.getElementById("controlPanel");let n=document.getElementById("controlBox");const i=this.mainBook.container.querySelector(".cont_table"),s=60*t+10*(t+1);o||(o=document.createElement("DIV"),n=document.createElement("DIV"),o.id="controlPanel",o.classList.add("eink"),n.id="controlBox",$(o).on("click",(e=>{e.stopPropagation(),this.hidePanel(e)})),function(){const e=document.createElement("STYLE");e.id="controlPanelStylesheet",e.textContent="\n    #controlPanel {\n      position: fixed;\n      top: 0px;\n      left: 0px;\n      z-index: 5000;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      background-color: rgba(0, 0, 0, 0.4);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n  }\n\n  #controlBox {\n      background-color: #fefefe;\n      display: flex;\n      width: 220px;\n      flex-wrap: wrap;\n      justify-content: space-evenly;\n      align-content: space-around;\n      padding: 10px;\n      border-radius: 20px;\n      border: 1px solid #888;\n  }\n\n  .ctrBtn {\n      display: flex;\n      width: 60px;\n      height: 60px;\n  }\n    ",document.head.appendChild(e)}()),n.innerHTML="",$(n).css("width",`${s}px`),0===e.length&&(e=[this.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGogFFCYWS2k_Hr2bYZQp3Vt36O-3kVUlnSK758Qon7mLhBpqADpL6h16B7ZU8r1u906cXMl4PGwyVyvMIVbmWTZSFy_9Oe4PFdgq6IAeQsYWGR9d2bC5gcpAsOcLTmk6TmE8Fq3roWg/s200/Icons.001.png",this.#H.bind(this),"increaseText"),this.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgigG2M2hO3UhFmHW0lMuqcJWp1xLA_PUqS5mBu1V0_45jUjEuBEmiXQMLwxqcQKbVVdRKLa88_ixO5ObMwj0_TitNM3-doOmbwH8sQcXud-24zHEKEqdA6l9nSyJ4mG5deegiImMi0Vw/s320/Icons.004.png",this.#j,"decreaseText"),this.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiTlsX1vb-orCpX4uUapoCvAPDMBx7el484_fEIu8M41gi9R7JSaV4XuJwqFXXIaPd3_nijiDoCBn12nrSj3geh1T8ESOO-wmatEB9xSoyRCqeedswk6-8ePKgHnjS1vnZTIQksOgnZqrPAwK38Ey_gKZUYnJTul0EQUw8OWmI169vdpw3MhelyDqLL/s1600/My%20Icons.002.jpeg",(()=>{this.highlighter.enterHighlightMode(this.bookContents)}),"highlightMode"),this.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLTmabfpczkcfTrJgzBo_LR-RWaJIhyTNM8A7p_WHA5J2TIqs4drAqgI8QHvJjxr707Xy-Jw56Iq9H8NEjE7BZ_Bf_3Lxd3Ff2EuyLJTI3PD9_yjgBQr7kX7NU8wLclfUfl-V_3y40YFdI9kpfZ2hqBDq1GmGrIDD1sgfEEqHzuGnXjhYfjcy8JVFB/s1600/My%20Icons.001.jpeg",(()=>{this.painter.enterDrawMode()}),"draw"),this.makePanelObj(this.toolBarIconSrc.noteBook_icon,this.highlighter.showNoteBook.bind(this.highlighter),"noteBook"),this.makePanelObj(this.toolBarIconSrc.printer,(()=>{window.print()}),"printMode"),this.makePanelObj(this.toolBarIconSrc.info_icon,(()=>{const e="zh-TW"===this.lang?"操作說明":"manual";$("#manualBox h3").text(e),this.manual.show()}),"showManual"),this.makePanelObj(this.toolBarIconSrc.scroll_mode,this.enterScrollMode,"scrollMode")],i?e.unshift(this.makePanelObj(this.toolBarIconSrc.content_table,this.checkContent,"checkContent")):e.unshift(this.makePanelObj(this.toolBarIconSrc.content_table,this.checkContent,"spacer_1"))),e.forEach((e=>{const t=document.createElement("DIV"),o=document.createElement("IMG");o.setAttribute("src",e.img),t.setAttribute("id",e.id),e.id.includes("spacer")&&(t.style.visibility="hidden"),t.onclick=e.func.bind(this),t.setAttribute("class","ctrBtn"),t.append(o),n.append(t)})),o.append(n),o.style.display="none",document.documentElement.append(o)}makePanelObj=(e,t,o)=>({img:e,func:t,id:o});checkContent(){const e=this.mainBook.findContTablePage();e&&(this.mainBook.currentPage=e)}hidePanel(e){e.stopPropagation(),$("#controlPanel").hide(),this.previewBook&&this.#z()}#F(e=!0,t="Loading..."){let o=document.getElementById("loadingWindow");if(e){if(this.#w=!0,!o){o=document.createElement("div"),o.id="loadingWindow",o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="rgba(0, 0, 0, 0.5)",o.style.zIndex="10000",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center";const e=document.createElement("div");if(e.style.backgroundColor="white",e.style.padding="20px",e.style.borderRadius="10px",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",e.style.textAlign="center",!this.isEinkDevice){const t=document.createElement("div");t.id="loadingSpinner",t.style.border="4px solid #f3f3f3",t.style.borderTop="4px solid #3498db",t.style.borderRadius="50%",t.style.width="30px",t.style.height="30px",t.style.animation="spin 1s linear infinite",t.style.margin="0 auto 10px auto";const o=document.createElement("style");o.textContent="@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }",document.head.appendChild(o),e.appendChild(t)}const t=document.createElement("div");t.id="loadingMessage",e.appendChild(t),o.appendChild(e),document.documentElement.appendChild(o)}document.getElementById("loadingMessage").textContent=t,o.style.display="flex";const e=document.getElementById("loadingSpinner");e&&(e.style.display=this.isEinkDevice?"none":"block")}else this.#w=!1,o&&(o.style.display="none")}#z(){if(0!==this.#d){this.#o=!1;let e,t,o,n,i=!1;this.#$(!0),this.previewBook.onpagechange=e=>{e.startPageNum===e.endPageNum&&(i=!0,this.#F(!0,"Loading...."))},this.previewBook.removeEventListener("touchstart touchend"),this.previewBook.addEventListener("touchstart",(e=>{e.stopPropagation(),n=e.touches.length,1===e.touches.length&&(t=e.touches[0].clientX,o=e.touches[0].clientY)}));const s=this.#m;this.previewBook.addEventListener("touchend",(i=>{if(i.stopPropagation(),1===n){const n=i.changedTouches[0].clientY-o,r=i.changedTouches[0].clientX-t,a=50;Math.abs(r)<a&&n>a?(e="tail",this.#o?(s.currentPage=s.totalPages,this.previewBook.remove(!0),this.previewBook=null,this.#m=null):this.#F()):Math.abs(r)<a&&n<-a&&(e="head",this.#o?(s.currentPage=1,this.previewBook.remove(!0),this.previewBook=null,this.#m=null):this.#F())}t=null,o=null})),new Promise((e=>{this.books.forEach((e=>{e!==this.previewBook&&e.changeFontSizeBy(this.#d)})),this.#d=0,e()})).then((()=>{this.#o=!0,this.#$(),this.#F(!1);const t=this.previewBook.previewRange;if(e)return this.#m.currentPage="head"===e?1:this.#m.totalPages,this.previewBook.remove(!0),this.previewBook=null,void(this.#m=null);if(i){const e=1===this.previewBook.currentPage?t.head:t.tail;return this.#m.currentPage=this.#m.getPageNumByItem(e),e===t.tail&&this.#m.hint(e),this.previewBook.remove(!0),this.previewBook=null,void(this.#m=null)}this.previewBook.onpagechange=e=>{let o;if(sessionStorage.setItem("pageNumBook"+this.previewBook.instanceID,""),e.startPageNum!==e.endPageNum)if(o=this.previewBook.getPageStarter(0),o.starter.nodeType===Node.TEXT_NODE){const e=document.createTreeWalker(t.commonAncestorContainer,NodeFilter.SHOW_TEXT,(e=>0===t.comparePoint(e,0)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT)),n=o.starter.textContent.slice(o.offset,o.starter.length);for(;e.nextNode();)if(e.currentNode.textContent.includes(n)&&e.currentNode.parentNode.nodeName===o.starter.parentNode.nodeName){const t=e.currentNode.textContent.indexOf(n),o=Book.rangeTool.createRange(e.currentNode,e.currentNode,t,t+30<e.currentNode.textContent.length?t+30:e.currentNode.textContent.length);this.#m.currentPage=this.#m.getPageNumByItem(o),this.#m.hint(o);break}}else{const e=document.createTreeWalker(t.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,null);let n;for(;e.nextNode();){const t=e.currentNode;if(t.outerHTML===o.starter.outerHTML){n=t,this.#m.currentPage=this.#m.getPageNumByItem(n),this.#m.hint(n);break}}n||(this.#m.currentPage+=this.previewBook.currentPage-1,this.#m.hint(o.starter))}else{const o=1===e.startPageNum?t.head:t.tail;this.#m.currentPage=this.#m.getPageNumByItem(o),o===t.tail&&this.#m.hint(o)}this.previewBook.remove(!0),this.previewBook=null,this.#m=null},this.previewBook.onhidden=()=>{this.previewBook.remove(!0),this.previewBook=null,this.#m=null}}))}else 0===this.#d&&(this.previewBook.remove(!0),this.previewBook=null,this.#m=null)}#H(e){e.stopPropagation(),this.#o&&this.#c<this.#g&&($(".draw").hide(),this.#c+=2,this.#d+=2,this.previewBook?this.previewBook.changeFontSizeBy(2):(this.#m=Book.focusedBook,this.previewBook=Book.focusedBook.quickPreview(Book.focusedBook.currentPage,Book.focusedBook.currentPage+6,2)),this.#$())}#j(e){e.stopPropagation(),this.#o&&this.#c>0&&($(".draw").hide(),this.#c-=2,this.#d-=2,this.previewBook?this.previewBook.changeFontSizeBy(-2):(this.#m=Book.focusedBook,this.previewBook=Book.focusedBook.quickPreview(Book.focusedBook.currentPage,Book.focusedBook.currentPage+6,-2)),this.#$())}#$(e=!1){e?($("#increaseText").children().replaceWith(Eink.getIconImg("increaseText_disabled")),$("#decreaseText").children().replaceWith(Eink.getIconImg("decreaseText_disabled"))):($("#increaseText").children().replaceWith(Eink.getIconImg(`increaseText_${this.#c===this.#g?"dis":"en"}abled`)),$("#decreaseText").children().replaceWith(Eink.getIconImg(`decreaseText_${0===this.#c?"dis":"en"}abled`)))}notReady(){const e="zh-TW"===this.lang?"請待網頁讀取完畢":"Please wait for the page to load completely.";this.showPopup(e),$(window).on("load",(()=>{const e="zh-TW"===this.lang?"網頁讀取完成":"Page loaded.";this.showPopup(e)}))}#N(e){clearTimeout(this.#k);let t=document.getElementById("sizeChangePopup");t||(t=document.createElement("div"),t.id="sizeChangePopup",document.body.appendChild(t)),t.textContent=e?`+${this.#c}`:`${this.#c}`,t.style.position="fixed",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="9999",t.style.display="block",this.#k=setTimeout((()=>{t.style.display="none"}),1e3)}resetPages(){this.books.forEach((e=>{e.resetPages()}))}enterScrollMode(){"eink.draw"===this.mode&&this.floatToolBar.exitDraw(),"eink.highlight"===this.mode&&this.floatToolBar.exitHighlight(),this.mode="scroll",sessionStorage.mode="scroll",this.removeEinkStyle(),this.books.forEach((e=>{e.enterScrollMode()})),$(window).off(".print"),this.manual.hide(),$(".draw").hide(),$("#einkBtn").show();let e="zh-TW"===this.lang?"滑動瀏覽模式":"Scroll Mode Activated";this.showPopup(e),document.documentElement.classList.remove("disable-default-touch"),this.onEnterScroll({books:this.books}),this.onSwitchMode({mode:"scroll",books:this.books})}showPopup(e="message"){let t=document.getElementById("einkPupup");t||(t=document.createElement("div"),t.id="einkPupup",t.classList.add(".eink"),document.documentElement.appendChild(t)),t.style.position="fixed",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="20px",t.style.borderRadius="10px",t.style.zIndex="9999",t.style.textAlign="center",t.textContent=e,t.style.display="block";const o=e=>{"pointerdown"===e?.type&&"pen"===e.pointerType||(t.style.display="none",$(window).off("popup"))};$(window).on("click.popup pointerdown.popup",o),setTimeout(o,2e3)}painter={eink:this,mode:"draw",currentBook:null,hasPen:!1,penActive:!1,penActiveTimer:null,muteTarget:null,color:"rgb(0, 0, 255)",hasMoved:!1,lineWidth:1,startTouch:null,maxTouchCount:0,lastTouchTime:0,oneTouchTime:null,prevColor:"rgb(0, 0, 255)",countTimer:null,flipTimer:null,pressTimer:null,currentCanvas:null,floatToolBar:null,selectionMode:!1,selectionCanvas:null,selectionCtx:null,storedSelectionPoints:[],offsetX:0,offsetY:0,lastTouch:null,handlePagechange:()=>{},enterDrawMode(){"complete"===document.readyState?(this.eink.floatToolBar.setFloatToolBar("draw"),"eink.draw"!==this.eink.mode&&(this.eink.mode="eink.draw",this.floatToolBar=this.eink.floatToolBar.view,this.eink.#L(),this.handlePagechange=e=>{this.createCanvas(e.book)},this.eink.books.forEach((e=>{this.createCanvas(e),e.addEventListener("pagechange",this.handlePagechange),e.preventGestures=!0})),$(".draw").css("pointer-events","auto"),this.eink.onenterdraw({books:this.eink.books}),this.eink.onSwitchMode({mode:"eink.draw",books:this.eink.books}))):this.eink.notReady()},createCanvas(e){if(e.isVisible&&e.bookConfig.allowDraw){let t=document.getElementById(this.getCanvasId(e));t||(t=document.createElement("CANVAS"),t.classList.add("draw"),t.id=this.getCanvasId(e),t.setAttribute("width",e.container.clientWidth+"px"),t.setAttribute("height",e.container.clientHeight+"px"),t.style.position="absolute",t.style.top="0px",t.style.left=e.container.scrollLeft+"px",t.style.zIndex="200",$(t).on("touchstart.draw",(e=>{e.preventDefault()})),$(t).on("pointerdown.draw",this.drawStart.bind(this)),$(t).on("pointermove.draw",this.drawMove.bind(this)),$(t).on("pointerup.draw",this.drawEnd.bind(this)),$(t).on("pointercancel.draw",this.drawCancel.bind(this)),this.eink.inIOSBrowser&&$(t).on("touchstart touchmove touchend touchcancel",(e=>{e.stopPropagation()})),e.container.append(t));const o=t.getBoundingClientRect();return t.offsetX=o.x,t.offsetY=o.y,this.hasPen?t.style.pointerEvents="none":t.style.pointerEvents="auto",t}},handlePenDown(e){if("pen"===e.pointerType){e.stopPropagation(),this.eink.bookContainers.includes(e.currentTarget)||(this.muteTarget=e.target,e.target.style.pointerEvents="none"),window.clearTimeout(this.penActiveTimer);const t=this.createCanvas(e.currentTarget.book);this.currentCanvas=t,this.offsetX=t.offsetX,this.offsetY=t.offsetY,$(t).trigger("pointerdown",{target:t,pointerType:"pen",pointerId:e.pointerId,clientX:e.clientX,clientY:e.clientY,buttons:e.buttons,button:e.button,stopPropagation:()=>{}}),t.setPointerCapture(e.pointerId),e.currentTarget.book.preventFlip=!0}else"touch"===e.pointerType&&(this.prevColor=this.color,(!this.lastTouch||this.lastTouch!==e&&Math.abs(e.clientX-this.lastTouch.clientX)>10)&&(this.maxTouchCount+=1,this.lastTouch=e),2===this.maxTouchCount?this.pressTimer=setTimeout((()=>{this.eink.floatToolBar.exitDraw()}),600):clearTimeout(this.pressTimer))},handleTouchUpWithPen(e){"touch"===e.pointerType&&(window.clearTimeout(this.pressTimer),window.clearTimeout(this.countTimer),this.maxTouchCount>=2&&(e.currentTarget.book.preventFlip=!0,2===this.maxTouchCount?this.color="rgb(0, 0, 255)":3===this.maxTouchCount?this.color="rgb(255, 0, 0)":4===this.maxTouchCount?this.color="rgb(0, 255, 0)":5===this.maxTouchCount&&(this.color="rgb(0, 0, 0)"),$("#mainIconImg").css("border-color",this.color)),this.lastTouchTime=performance.now(),this.countTimer=setTimeout((()=>{e.currentTarget.book.preventFlip=!1,this.maxTouchCount=0,this.lastTouch=null}),300))},drawStart(e,t){if(e.preventDefault(),e.stopPropagation(),t&&(e=t),this.currentBook=e.target.parentElement.book,this.currentCanvas!==e.target&&(this.currentCanvas=e.target,this.offsetX=e.target.offsetX,this.offsetY=e.target.offsetY),this.selectionMode)this.startTouch=e,this.storedSelectionPoints.push([e.clientX-this.offsetX,e.clientY-this.offsetY]),this.selectionCanvas=this.currentCanvas.cloneNode(),this.selectionCanvas.id="selectionCanvas",this.currentBook.container.append(this.selectionCanvas),this.selectionCtx=this.selectionCanvas.getContext("2d"),this.selectionCtx.strokeStyle="rgba(255, 0, 0, 0.8)",this.selectionCtx.lineWidth=2,this.selectionCtx.setLineDash([10,10]),this.selectionCtx.beginPath();else if(this.penActive||"touch"!==e.pointerType)if("pen"===e.pointerType){window.clearTimeout(this.flipTimer),this.hasPen||this.eink.inIOSBrowser||(this.hasPen=!0,this.eink.#I(),$(".draw").css("pointer-events","none"),this.eink.books.forEach((e=>{$(e.container).on("pointerdown.draw",this.handlePenDown.bind(this)),$(e.container).on("pointerup.draw pointercancel.draw",this.handleTouchUpWithPen.bind(this))}))),this.eink.inIOSBrowser?$(this.floatToolBar).show():$(this.floatToolBar).hide(),this.penActive=!0,this.startTouch=e,this.currentBook.preventGestures=!0;performance.now()-this.lastTouchTime<500?this.color=this.prevColor:this.prevColor=this.color}else"mouse"===e.pointerType&&(this.startTouch=e);else{window.clearTimeout(this.countTimer),(!this.lastTouch||this.lastTouch!==e&&Math.abs(e.clientX-this.lastTouch.clientX)>10)&&(this.maxTouchCount+=1,this.lastTouch=e),this.prevColor=this.color;const t=this.maxTouchCount;clearTimeout(this.pressTimer),1===t?(this.startTouch=e,this.oneTouchTime=performance.now()):2===t?(this.pressTimer=setTimeout((()=>{this.eink.floatToolBar.exitDraw()}),600),this.startTouch=null):this.startTouch=null}!0===this.floatToolBar.submenuOn&&(this.floatToolBar.toggleSubmenu(e),"touch"===e.type&&(this.currentBook.preventFlip=1))},drawMove(e){if(e.preventDefault(),e.stopPropagation(),this.maxTouchCount=0,this.lastTouch=0,this.startTouch&&this.startTouch.pointerId===e.pointerId){const t=e.target.getContext("2d");if(this.hasMoved=!0,this.selectionMode){const t=this.storedSelectionPoints[this.storedSelectionPoints.length-1],o=[e.clientX-this.offsetX,e.clientY-this.offsetY],n=Math.sqrt(Math.pow(o[0]-t[0],2)+Math.pow(o[1]-t[1],2));this.totalPathLength=(this.totalPathLength||0)+n;const i=[10,10];this.selectionCtx.setLineDash(i),this.selectionCtx.lineDashOffset=-this.totalPathLength%(i[0]+i[1]),this.selectionCtx.beginPath(),this.selectionCtx.moveTo(t[0],t[1]),this.selectionCtx.lineTo(o[0],o[1]),this.selectionCtx.stroke(),this.storedSelectionPoints.push(o)}else if("draw"!==this.mode||"touch"!==e.pointerType&&1!==e.buttons){let o;const n=e.originalEvent.pressure?e.originalEvent.pressure:.5;o=100*(32===e.buttons?2:1)*n,t.clearRect(e.clientX-this.offsetX-o/2,e.clientY-this.offsetY-o/2,o,o)}else this.maxTouchCount=0,t.beginPath(),t.moveTo(this.startTouch.clientX-this.offsetX,this.startTouch.clientY-this.offsetY),t.lineTo(e.clientX-this.offsetX,e.clientY-this.offsetY),t.lineWidth="pen"===e.pointerType?this.lineWidth*e.originalEvent.pressure*5:this.lineWidth,t.strokeStyle=this.color,t.stroke(),this.startTouch=e}},drawEnd(e){e.preventDefault(),e.stopPropagation(),this.selectionMode&&this.eraseSelection(e.target),"touch"===e.pointerType?(clearTimeout(this.pressTimer),1===this.maxTouchCount&&performance.now()-this.oneTouchTime<300&&!this.hasMoved?this.flipTimer=setTimeout((()=>{$(e.target).trigger({type:"click",clientX:e.clientX,clientY:e.clientY})}),100):(window.clearTimeout(this.flipTimer),2===this.maxTouchCount?this.color="rgb(0, 0, 255)":3===this.maxTouchCount?this.color="rgb(255, 0, 0)":4===this.maxTouchCount?this.color="rgb(0, 255, 0)":5===this.maxTouchCount&&(this.color="rgb(0, 0, 0)"),$("#mainIconImg").css("border-color",this.color)),this.lastTouchTime=performance.now(),this.countTimer=setTimeout((()=>{this.lastTouch=null,this.maxTouchCount=0}),150)):"pen"===e.pointerType?this.penActiveTimer=setTimeout((()=>{this.muteTarget&&(this.muteTarget.style.pointerEvents="auto",this.muteTarget=null),this.penActive=!1,this.currentBook.preventFlip=!1,this.currentBook.preventGestures=!1}),300):"mouse"===e.pointerType&&this.hasMoved&&(this.currentBook.preventFlip=1),this.startTouch=null,this.hasMoved=!1},drawCancel(e){e.preventDefault(),this.selectionMode&&this.eraseSelection(e.target),"touch"===e.pointerType?(clearTimeout(this.pressTimer),window.clearTimeout(this.flipTimer),2===this.maxTouchCount?this.color="rgb(0, 0, 255)":3===this.maxTouchCount?this.color="rgb(255, 0, 0)":4===this.maxTouchCount?this.color="rgb(0, 255, 0)":5===this.maxTouchCount&&(this.color="rgb(0, 0, 0)"),$("#mainIconImg").css("border-color",this.color),this.lastTouchTime=performance.now(),this.countTimer=setTimeout((()=>{this.lastTouch=null,this.maxTouchCount=0}),150)):"pen"===e.pointerType?this.penActiveTimer=setTimeout((()=>{this.muteTarget&&(this.muteTarget.style.pointerEvents="auto",this.muteTarget=null),this.penActive=!1,this.currentBook.preventFlip=!1,this.currentBook.preventGestures=!1}),300):"mouse"===e.pointerType&&this.hasMoved&&(this.currentBook.preventFlip=1),this.startTouch=null,this.hasMoved=!1},eraseSelection(e){this.selectionCanvas.remove();const t=e.getContext("2d");t.save(),t.globalCompositeOperation="destination-out",t.beginPath(),t.moveTo(this.storedSelectionPoints[0][0],this.storedSelectionPoints[0][1]);for(let e=1;e<this.storedSelectionPoints.length;e++)t.lineTo(this.storedSelectionPoints[e][0],this.storedSelectionPoints[e][1]);t.closePath(),t.fill(),t.restore(),this.storedSelectionPoints=[],this.selectionCanvas=null,this.selectionCtx=null},getCanvasId(e){const t="vertical"===e.bookConfig.pagingMethod?e.container.scrollHeight:e.container.scrollWidth;return"draw"+e.currentPage+"_"+e.instanceID+"_"+Math.round(e.container.clientWidth)+"_"+Math.round(e.container.clientHeight)+"_"+parseInt($(e.contents).css("font-size"))+"_"+t},disableDraw(){this.hasPen&&(this.hasPen=!1,this.eink.books.forEach((e=>{$(e.container).off(".draw")})),this.eink.#L()),$(this.floatToolBar).hide(),this.floatToolBar.submenuOn&&this.floatToolBar.toggleSubmenu(),this.floatToolBar=null,this.boundCreateCanvas=this.createCanvas.bind(this),this.eink.books.forEach((e=>{e.removeEventListener("pagechange",this.handlePagechange),e.preventGestures=!1})),$(".draw").css("pointer-events","none")}};highlighter={eink:this,targetRange:void 0,marks:[],highlightAreas:[],highlightMoved:!1,highlightColor:"rgb(0, 255, 0)",highlightColorName:"green",cachedStarterText:null,cachedMode:null,reverseDir:!1,maxTouchCount:0,book:void 0,highlightBook:void 0,highlightRemoved:!1,tx0:null,ty0:null,countTimer:null,longPressTimer:null,lastTouch:null,enterHighlightMode(e){"complete"===document.readyState?("eink.draw"===this.eink.mode&&this.eink.floatToolBar.exitDraw(),this.eink.mode="eink.highlight",this.eink.floatToolBar.setFloatToolBar("highlight"),this.eink.#L(),this.highlightAreas=e,e.forEach((e=>{e&&($(e).on("pointerdown.highlight",this.startHighlight.bind(this)),$(e).on("pointermove.highlight",this.moveHighlight.bind(this)),$(e).on("pointerup.highlight pointercancel.highlight",this.endHighlight.bind(this)),this.eink.inIOSBrowser||e.classList.add("no-select"))})),this.eink.onenterhighlight(e),this.eink.onSwitchMode({mode:"eink.highlight"})):this.eink.notReady()},startHighlight(e){e.preventDefault(),e.stopPropagation();const t=document.getElementById("floatToolBar");if(!0!==t.submenuOn){if("touch"===e.pointerType&&(clearTimeout(this.countTimer),this.lastTouch?Math.abs(e.clientX-this.lastTouch.clientX)>10&&this.maxTouchCount++:(this.lastTouch=e,this.maxTouchCount++)),!1!==e.target.closest(".bookContents").book.bookConfig.allowHighlight)if(1===this.maxTouchCount||["pen","mouse"].includes(e.pointerType)){const{clientX:t,clientY:o}="touch"===e.setPointerType?this.lastTouch:e;this.tx0=t,this.ty0=o;const n=document.elementFromPoint(t,o);if(this.book=n?.closest(".book")?.book,this.book&&this.pointWithinThePage(this.book,t,o))if(this.cachedStarterText=this.book.pageStarter.starter.textContent,"rgb(128, 128, 128)"===this.highlightColor||32===e.buttons||e.altKey&&1===e.buttons)n&&this.removeHighlight(this.book,n);else if(this.targetRange=this.getCaretRangeFromPoint(t,o),this.targetRange)if(this.highlightColorName={"rgb(255, 0, 0)":"red","rgb(0, 0, 255)":"blue","rgb(0, 255, 0)":"green","rgb(128, 128, 128)":"gray"}[this.highlightColor],this.targetRange.startOffset>0){this.targetRange.setStart(this.targetRange.startContainer,this.targetRange.startOffset-1);const{left:e,right:o}=this.targetRange.getBoundingClientRect();if(!(e<=t&&t<=o))try{this.targetRange.setStart(this.targetRange.startContainer,this.targetRange.startOffset+1),this.targetRange.setEnd(this.targetRange.endContainer,this.targetRange.endOffset+1)}catch(e){return}}else try{this.targetRange.setEnd(this.targetRange.endContainer,this.targetRange.endOffset+1)}catch(e){return}}else 2===this.maxTouchCount?this.longPressTimer=setTimeout((()=>{this.lastTouch=null,this.maxTouchCount=0,this.highlightMoved=!1,this.tx0=null,this.ty0=null,this.book=void 0,this.highlightRemoved=!1,this.eink.floatToolBar.exitHighlight(e)}),600):(this.targetRange=void 0,clearTimeout(this.longPressTimer))}else t.toggleSubmenu(e)},moveHighlight(e){if(e.preventDefault(),e.stopPropagation(),1===this.maxTouchCount||"pen"===e.pointerType||"mouse"===e.pointerType&&1===e.buttons){if("none"===this.eink.floatToolBar.view.style.display&&!e.metaKey&&!e.altKey)return;const{clientX:t,clientY:o}=e;if("touch"===e.pointerType&&Math.abs(t-this.tx0)<5&&Math.abs(o-this.ty0)<5||"pen"===e.pointerType&&Math.abs(t-this.tx0)<3&&Math.abs(o-this.ty0)<3)return;if(!1===e.target.closest(".bookContents").book.bookConfig.allowHighlight){let e="zh-TW"===this.eink.lang?"這本書不可螢光畫註":"Highlighting is not allowed for this book.";return void this.eink.showPopup(e)}if(this.highlightMoved=!0,"rgb(128, 128, 128)"===this.highlightColor||32===e.buttons||e.altKey&&1===e.buttons){const e=document.elementFromPoint(t,o);e&&this.removeHighlight(this.book,e)}else if(this.targetRange&&this.pointWithinThePage(this.book,t,o)){const{startContainer:e,endOffset:n}=this.getCaretRangeFromPoint(t,o);if(this.targetRange.startContainer.nodeType===Node.TEXT_NODE&&e.nodeType===Node.TEXT_NODE){if($(".client-rect-overlay").remove(),this.reverseDir){let t=Book.rangeTool.createRange(e,this.targetRange.endContainer,n,this.targetRange.endOffset);t.collapsed?(this.reverseDir=!this.reverseDir,this.targetRange=Book.rangeTool.createRange(this.targetRange.endContainer,e,this.targetRange.endOffset-1,n)):this.targetRange=t}else{let t=Book.rangeTool.createRange(this.targetRange.startContainer,e,this.targetRange.startOffset,n);t.collapsed?(this.reverseDir=!this.reverseDir,this.targetRange=Book.rangeTool.createRange(e,this.targetRange.startContainer,n,this.targetRange.startOffset+1)):this.targetRange=t}this.modifyTextNodeRanges(this.targetRange,(e=>{this.addClientRectsOverlay(e,this.highlightColor)}))}}}},pointWithinThePage(e,t,o){const{left:n,right:i,top:s,bottom:r}=e.container.getBoundingClientRect();return t>n+e.bookConfig.leftMargin&&t<i-e.bookConfig.rightMargin-10&&o>s+e.bookConfig.upperMargin&&o<r-e.bookConfig.lowerMargin-10},endHighlight(e){e.preventDefault(),e.stopPropagation(),this.targetRange&&this.highlightMoved&&!this.targetRange.collapsed&&(this.modifyTextNodeRanges(this.targetRange,(e=>{this.markRange(e,this.highlightColorName)})),$(".client-rect-overlay").remove(),this.joinHighlights(),this.targetRange=void 0,this.marks=[]),"touch"===e.pointerType&&(clearTimeout(this.longPressTimer),2===this.maxTouchCount?this.highlightColor="rgb(0, 255, 0)":3===this.maxTouchCount?this.highlightColor="rgb(255, 0, 0)":4===this.maxTouchCount?this.highlightColor="rgb(0, 0, 255)":5===this.maxTouchCount&&(this.highlightColor="rgb(128, 128, 128)"),this.eink.floatToolBar.changeHighlightColor({target:$(".toolDiv img").filter(((e,t)=>t.style.borderColor===this.highlightColor))[0].parentElement,stopPropagation:()=>{}}),this.countTimer=setTimeout((()=>{this.lastTouch=null,this.maxTouchCount=0}),150)),this.book&&("mouse"===e.pointerType&&this.highlightMoved?this.book.preventFlip=1:"touch"!==e.pointerType&&"pen"!==e.pointerType||(this.book.preventGestures=1),this.highlightMoved&&this.highlightRemoved&&(this.book.preventFlip=1),this.book.pageStarter=this.book.getPageStarter(),this.book.ignoreMutation=1,this.book=void 0),this.targetRange=void 0,this.marks=[],this.highlightRemoved=!1,this.highlightMoved=!1,this.tx0=null,this.ty0=null,"mouse"===e.pointerType&&"none"===this.eink.floatToolBar.view.style.display&&this.eink.floatToolBar.exitHighlight(e)},modifyTextNodeRanges(e,t){const o=function(e){const t=[],o=document.createTreeWalker(e.commonAncestorContainer,NodeFilter.SHOW_TEXT,(t=>0===e.comparePoint(t,0)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT));let n=o.nextNode();for(;n&&n!==e.endContainer;)n!==e.startContainer&&t.push(n),n=o.nextNode();return t}(e);e.startContainer===e.endContainer?t(e):(t(Book.rangeTool.createRange(e.startContainer,e.startContainer,e.startOffset,e.startContainer.length)),o.forEach((e=>{t(Book.rangeTool.createRange(e,e,0,e.textContent.length))})),t(Book.rangeTool.createRange(e.endContainer,e.endContainer,0,e.endOffset)))},getCaretRangeFromPoint(e,t){if(document.caretPositionFromPoint){const o=document.caretPositionFromPoint(e,t);if(o){const e=document.createRange();return e.setStart(o.offsetNode,o.offset),e.collapse(!0),e}}else if(document.caretRangeFromPoint)return document.caretRangeFromPoint(e,t);return null},markRange(e,t){const o=document.createElement(`${t}mark`.toUpperCase());e.surroundContents(o),this.marks.push(o)},addClientRectsOverlay(e,t){t=t.slice(0,-1)+", 0.33";for(const o of e.getClientRects()){const e=document.createElement("div");e.classList.add("client-rect-overlay"),e.style.position="absolute",e.style.backgroundColor=t,e.style.pointerEvents="none";const n=document.documentElement.scrollTop,i=document.documentElement.scrollLeft;e.style.margin=e.style.padding="0",e.style.top=`${o.top+n}px`,e.style.left=`${o.left+i}px`,e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,e.style.zIndex="999999",document.documentElement.appendChild(e)}},async joinHighlights(){let e=[],t=!0;if(this.marks.length>0){for(let n=0;n<this.marks.length;n++){let i=this.marks[n];if(0===n&&i.previousSibling&&i.previousSibling.previousSibling){const e=i.previousSibling;if(e===this.book.pageStarter.starter&&e.previousSibling.nodeName===i.nodeName){if([",",".",";",":",">",")","]","}","!","?","，","。","、","：","；","！","？","」","』","》"].includes(e.previousSibling.textContent.slice(-1))){const e=this.book,{bottom:o}=i.getBoundingClientRect();let n="";n="zh-TW"===e.bookConfig.lang?"是否要將前一頁的螢光筆畫註結合？":"Join highlights on the previous page?",t=await this.eink.customConfirm(n,"default",o/2,e.pageWidth),e.ignoreMutation=1}}}if(i.parentElement){if(i.parentElement.normalize(),i=o(i),t)for(;i.previousSibling?.nodeName===i.nodeName;)i.innerHTML=i.previousSibling.innerHTML+i.innerHTML,i.previousSibling.remove(),i.parentElement.normalize(),i=o(i);for(;i.nextSibling?.nodeName===i.nodeName;)i.innerHTML+=i.nextSibling.innerHTML,i.nextSibling.remove(),i.parentElement.normalize(),i=o(i)}else e.push(i),this.marks.splice(n,1),n--}e.length>0&&(e=[],this.joinHighlights())}function o(e){for(;e.outerHTML===e.parentElement.innerHTML;){if(!("inline"===getComputedStyle(e.parentElement).display))break;{const t=document.createElement(`${e.nodeName}`.toUpperCase()),o=e.parentElement;e.outerHTML=e.innerHTML,t.innerHTML=o.outerHTML,o.parentElement.replaceChild(t,o),e=t}}return e}$("greenmark, bluemark, redmark").filter((function(){return Book.isElementEmpty(this)})).remove()},removeHighlight(e,t){const o=t?.closest("redmark, bluemark, greenmark");o&&(o.outerHTML=o.innerHTML,e.ignoreMutation=1,this.highlightRemoved=!0)},showNoteBook(){if("complete"!==document.readyState)return void this.eink.notReady();this.cachedMode=this.eink.mode,"eink.highlight"===this.eink.mode?this.eink.floatToolBar.exitHighlight():"eink.draw"===this.eink.mode&&this.eink.floatToolBar.exitDraw(),this.eink.mode="eink.notebook";const e=[this.eink.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGogFFCYWS2k_Hr2bYZQp3Vt36O-3kVUlnSK758Qon7mLhBpqADpL6h16B7ZU8r1u906cXMl4PGwyVyvMIVbmWTZSFy_9Oe4PFdgq6IAeQsYWGR9d2bC5gcpAsOcLTmk6TmE8Fq3roWg/s200/Icons.001.png",this.eink.#H,"increaseText"),this.eink.makePanelObj("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgigG2M2hO3UhFmHW0lMuqcJWp1xLA_PUqS5mBu1V0_45jUjEuBEmiXQMLwxqcQKbVVdRKLa88_ixO5ObMwj0_TitNM3-doOmbwH8sQcXud-24zHEKEqdA6l9nSyJ4mG5deegiImMi0Vw/s320/Icons.004.png",this.eink.#j,"decreaseText"),this.eink.makePanelObj(this.eink.toolBarIconSrc.printer,(()=>{window.print()}),"printMode"),this.eink.makePanelObj(this.eink.toolBarIconSrc.exit_icon,this.hideNoteBook.bind(this),"hideNoteBook")];let t,o;if(this.eink.setupControl(e,2),$("HTML > *").hide(),this.highlightBook)t=this.highlightBook.container,o=t.querySelector(".highlight-section"),$(t).show();else{t=document.createElement("div");const e=document.createElement("h4"),n=document.createElement("h4"),i=document.createElement("h2"),s=document.createElement("h3");o=document.createElement("div"),o.classList.add("highlight-section"),t.classList.add("noteBook"),this.eink.mainBook.bookTitle&&(i.textContent=this.eink.mainBook.bookTitle.textContent),t.append(i),e.innerHTML=`Author: <span style="color:blue;">${this.eink.mainBook.author}</span>`,e.classList.add("author"),e.setAttribute("ignoreTable","true"),t.append(e),n.innerHTML=`<b>Original Article: </b><a href="${window.location.href}">${window.location.href}</a>`,n.href=window.location.href,n.classList.add("web-address"),n.setAttribute("ignoreTable","true"),t.append(n),s.classList.add("highlight-title"),s.textContent="Highlights",s.setAttribute("ignoreTable","true"),s.style.backgroundColor="yellow",t.append(s),t.append(o),document.documentElement.appendChild(t),this.highlightBook=new Book(t,{useNotes:!1,allowDraw:!1,allowHighlight:!1}),this.highlightBook.enterEinkMode()}o.innerHTML="",["greenmark","bluemark","redmark"].forEach((e=>{!function(e){const t=$("body").find(e).filter(((e,t)=>!t.parentElement?.closest("redmark, bluemark, greenmark")));if(t.length>0){const n=document.createElement("h4"),i=document.createElement("ul"),s=e.replace("mark","");n.textContent=s.charAt(0).toUpperCase()+s.slice(1)+" Marks",n.style.color=s,o.append(n),t.each(((e,t)=>{const o=document.createElement("li");o.innerHTML=t.innerHTML,i.append(o)})),o.append(i)}}(e)})),this.eink.onSwitchMode({mode:"eink.notebook"})},hideNoteBook(){$("body").show(),$(window).off(".notebook"),$(this.highlightBook.container).hide(),this.eink.setupControl(),"eink.highlight"===this.cachedMode?this.enterHighlightMode(this.eink.bookContents):(this.eink.mode="eink.read",this.eink.onSwitchMode({mode:"eink.read"}))}};floatToolBar={eink:this,book:null,view:null,toolObjs:{},mainTool:{},lineWidthIcons:{},toolColors:[],mouseMoved:!1,x0:0,y0:0,iconSrc:this.toolBarIconSrc,getColorName:e=>({"rgb(255, 0, 0)":"red","rgb(0, 0, 255)":"blue","rgb(0, 255, 0)":"green","rgb(128, 128, 128)":"gray"}[e]),getColorCode:e=>({red:"rgb(255, 0, 0)",blue:"rgb(0, 0, 255)",green:"rgb(0, 255, 0)",gray:"rgb(128, 128, 128)"}[e]),setFloatToolBar(e){if(this.view&&this.view.mode===e)return $(this.view).show(),this.view;{this.view?.remove();const t=document.createElement("DIV");let o,n;const i=40;this.view=t,this.view.toggleSubmenu=this.toggleSubmenu.bind(this),this.view.submenuOn=!1,this.view.eraseMode=!1,this.view.mode=e,this.toolColors=["rgb(0, 255, 0)","rgb(0, 0, 255)","rgb(255, 0, 0)","rgb(128, 128, 128)","rgb(0, 0, 0)"],this.view.classList.add("floatToolBar"),this.view.classList.add("eink"),this.view.id="floatToolBar",this.view.style.top="250px",this.view.style.width=i+"px","draw"===e?(o=this.eink.painter.color,n=this.eink.painter.lineWidth,this.lineWidthIcons={1:"lightLine_icon",2:"mediumLine_icon",3:"heavyLine_icon"},this.toolObjs={pencil:this.makeTool("pencilActivated_icon",this.toggleSubmenu.bind(this),"pencil"),colorPt:this.makeTool("",this.showColorPt.bind(this),"showColorPt"),lineWidth:this.makeTool(this.lineWidthIcons[n],this.showLineWidth.bind(this),"showLineWidth"),eraser:this.makeTool("eraser_icon",this.toggleEraser.bind(this),"toggleEraser"),selection_erase:this.makeTool("selection_erase",this.toggleSelectionEraseMode.bind(this),"selectionErase"),exit:this.makeTool("flip_icon",(e=>{this.exitDraw(e)}),"exitDraw")}):(o=this.eink.highlighter.highlightColor,n=1,this.toolObjs={greenMark:this.makeTool("greenMarkPen_icon",this.changeHighlightColor.bind(this),"greenMark"),blueMark:this.makeTool("blueMarkPen_icon",this.changeHighlightColor.bind(this),"blueMark"),redMark:this.makeTool("redMarkPen_icon",this.changeHighlightColor.bind(this),"redMark"),eraser:this.makeTool("eraser_icon",this.changeHighlightColor.bind(this),"toggleEraser"),notebook:this.makeTool("noteBook_icon",(()=>{this.eink.highlighter.showNoteBook()}),"showNoteBook"),exit:this.makeTool("close_icon",this.exitHighlight,"exitHighlight")});const s=document.createElement("DIV"),r="draw"===e?this.toolObjs.pencil:this.toolObjs[this.getColorName(o)+"Mark"],a=Eink.getIconImg(r.icon);s.id="mainIcon",s.classList.add("toolDiv"),s.style.opacity="0.7",a.id="mainIconImg",a.style.borderStyle="solid",a.style.borderWidth=1.3*n+"px",a.style.borderColor=o,$(s).on("click",(e=>{this.mouseMoved?this.mouseMoved=!1:r.func(e)})),s.append(a),t.append(s);const l=document.createElement("DIV"),h=Object.keys(this.toolObjs).length;return l.id="submenu",l.style.flexDirection="column",l.style.justifyContent="space-evenly",l.style.height=i*h+"px",l.style.display="none",Object.entries(this.toolObjs).forEach((([t,n])=>{if(n.name!==r.name){const i=document.createElement("DIV");if(i.id=n.name,i.classList.add("toolDiv"),"showColorPt"===i.id?i.innerHTML=`<div style="background-color:${o}"> </div>`:i.appendChild(Eink.getIconImg(n.icon)),"draw"!==e){const e=Object.keys(this.toolObjs).indexOf(t);e<this.toolColors.length&&(i.children[0].style.borderColor=this.toolColors[e])}$(i).on("click",(e=>{this.mouseMoved?this.mouseMoved=!1:n.func(e)})),l.append(i)}})),t.append(l),document.documentElement.append(t),$(".toolDiv").on("pointerdown",this.handleToolBarMoveStart.bind(this)),$(".toolDiv").on("pointermove",this.handleToolBarMove.bind(this)),$(".toolDiv").on("pointerup",this.handleToolBarMoveEnd.bind(this)),t}},getIconImg(e,t){const o=document.getElementById(e).cloneNode(!0);return o.removeAttribute("id"),t&&(o.id=t),o},toggleSelectionEraseMode(){this.view.submenuOn&&this.toggleSubmenu(),!0===this.eink.painter.selectionMode?($("#mainIconImg").replaceWith(Eink.getIconImg("pencilActivated_icon","mainIconImg")),$("#selectionErase img").replaceWith(Eink.getIconImg("selection_erase"))):!1===this.view.eraseMode?($("#mainIconImg").replaceWith(Eink.getIconImg("selection_erase","mainIconImg")),$("#selectionErase img").replaceWith(Eink.getIconImg("pencil_icon"))):($("#mainIconImg").replaceWith(Eink.getIconImg("selection_erase","mainIconImg")),$("#selectionErase img").replaceWith(Eink.getIconImg("pencil_icon")),$("#toggleEraser img").replaceWith(Eink.getIconImg("eraser_icon")),this.view.eraseMode=!1,this.eink.painter.mode="draw"),this.eink.painter.selectionMode=!this.eink.painter.selectionMode},repositionFloatToolBar(){if(this.view){const e=this.view,t="none"===$(e).css("display");t&&$(e).show();const{left:o,top:n,bottom:i,right:s,width:r,height:a}=e.getBoundingClientRect();o<0?e.style.left="0px":s>window.innerWidth&&(e.style.left=window.innerWidth-r+"px"),n<0?e.style.top="0px":i>window.innerHeight&&(e.style.top=window.innerHeight-a+"px"),t&&$(e).hide()}},handleToolBarMoveStart(e){if(e.stopPropagation(),"touch"===e.pointerType||1===e.buttons){const t=this.view;this.x0=e.clientX-t.offsetLeft,this.y0=e.clientY-t.offsetTop}"mouse"!==e.pointerType&&"pen"!==e.pointerType||e.target.setPointerCapture(e.pointerId)},handleToolBarMove(e){if(e.stopPropagation(),this.x0&&this.y0){if("mouse"===e.pointerType){if(!(Math.abs(e.clientX-this.x0)>5||Math.abs(e.clientY-this.y0)>5)||1!==e.buttons)return;this.mouseMoved=!0}const t=this.view,o=e.clientY-this.y0,n=e.clientX-this.x0,i=o+t.clientHeight,s=n+t.clientWidth;$("#paletteBlock").remove(),$("#lineWidthBlock").remove(),o>=0&&i<=window.innerHeight&&(t.style.top=o+"px"),n>=0&&s<=window.innerWidth&&(t.style.left=n+"px")}},handleToolBarMoveEnd(e){e.stopPropagation(),this.x0=null,this.y0=null},toggleSubmenu(e){e?.stopPropagation();const t=document.getElementById("floatToolBar"),o=t.querySelector("#submenu"),n=$("#mainIcon").width(),i=n*(o.children.length+1+1);!1===t.submenuOn?(o.style.display="flex",t.style.height=i+"px",t.style.width=n+"px",o.style.height=i-n+"px",o.style.width=n+"px",parseInt(t.style.top)+i<window.innerHeight?(t.style.flexDirection="column",o.style.flexDirection="column"):(t.style.flexDirection="column-reverse",o.style.flexDirection="column-reverse",t.style.top=parseInt(t.style.top)+n-i+"px"),"draw"===t.mode&&($("#showLineWidth img").replaceWith(Eink.getIconImg(this.lineWidthIcons[this.eink.painter.lineWidth])),$("#showColorPt *").css("background-color",this.eink.painter.color)),$("#mainIcon").css("opacity","1")):("column-reverse"===t.style.flexDirection&&(t.style.top=parseInt(t.style.top)-n+i+"px"),t.style.height=n+"px",o.style.display="none",$("#mainIcon").css("opacity","0.7"),$("#lineWidthBlock").remove(),$("#paletteBlock").remove()),t.submenuOn=!t.submenuOn},showColorPt(e){if(e.stopPropagation(),document.getElementById("paletteBlock"))$("#paletteBlock").remove();else{$("#lineWidthBlock").remove();const t=parseInt($(this.view).css("width")),o=this.eink.painter.color,n=this.toolColors,i=document.createElement("DIV"),s=e.target.offsetParent.offsetLeft;i.id="paletteBlock",i.classList.add("floatToolBar"),i.style.flexDirection="row",i.style.flexWrap="wrap",i.style.width=t*((n.length-1)/2)+20+"px",i.style.height=2*t+t/2+"px",i.style.top=e.target.offsetParent.offsetTop+e.target.offsetTop+"px",s>parseInt(i.style.width)?i.style.left=s-parseInt(i.style.width)-5+"px":i.style.left=s+t+5+"px",document.documentElement.append(i),$("#paletteBlock").on("click touchstart touchmove touchend",(function(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation()})),n.forEach((e=>{const n=document.createElement("div");o!==e&&(n.style.display="flex",n.style.width=t+"px",n.style.height=t+"px",n.style.backgroundColor=e,n.style.borderRadius="100%",n.onclick=this.colorPicked.bind(this),i.append(n))}))}},colorPicked(e){e.stopPropagation();const t=e.target.style.backgroundColor;$("#showColorPt").children().css("background-color",t),$("#paletteBlock").remove(),$("#mainIconImg").css("border-color",t),!0===this.view.eraseMode&&this.toggleEraser(e),this.eink.painter.color=t},showLineWidth(e){if(document.getElementById("lineWidthBlock"))$("#lineWidthBlock").remove();else{const t=document.getElementById("floatToolBar");$("#paletteBlock").remove();const o=this.eink.painter.lineWidth,n=parseInt($(t).css("width")),i=document.createElement("DIV"),s=e.target.offsetParent.offsetLeft,r=Object.keys(this.lineWidthIcons).length-1;i.id="lineWidthBlock",i.classList.add("floatToolBar"),i.style.flexDirection="row",i.style.width=n*r+10+"px",i.style.height=n+"px",i.style.top=e.target.offsetParent.offsetTop+e.target.offsetTop+"px",s>parseInt(i.style.width)?i.style.left=s-parseInt(i.style.width)-5+"px":i.style.left=s+n+5+"px",document.documentElement.append(i),$("#lineWidthBlock").on("click touchstart touchmove touchend",(function(e){"touchmove"===e.type&&e.preventDefault(),e.stopPropagation()}));for(const e in this.lineWidthIcons)if(e!=o){const t=Eink.getIconImg(this.lineWidthIcons[e]);t.setAttribute("lineWidth",e),t.style.display="flex",t.style.border="1px solid red",t.style.width=n-2+"px",t.style.height=n-2+"px",t.style.borderRadius="100%",t.onclick=this.widthPicked.bind(this),i.append(t)}}},widthPicked(e){e.stopPropagation();let t=e.target.getAttribute("lineWidth");const o=document.getElementById("showLineWidth").firstElementChild;document.getElementById("showLineWidth").replaceChild(e.target,o),e.target.onclick=void 0,$("#mainIconImg").css("border-width",1.3*t),$("#lineWidthBlock").remove(),this.eink.painter.lineWidth=t,this.view.eraseMode&&this.toggleEraser()},toggleEraser(e){e?.stopPropagation();const t=document.getElementById("mainIconImg").style.borderColor,o=parseInt(document.getElementById("mainIconImg").style.borderWidth);!0===this.view.eraseMode?($("#mainIconImg").replaceWith(Eink.getIconImg("pencilActivated_icon","mainIconImg")),$("#toggleEraser img").replaceWith(Eink.getIconImg("eraser_icon"))):!1===this.eink.painter.selectionMode?($("#mainIconImg").replaceWith(Eink.getIconImg("eraserActivated_icon","mainIconImg")),$("#toggleEraser img").replaceWith(Eink.getIconImg("pencil_icon"))):($("#mainIconImg").replaceWith(Eink.getIconImg("eraserActivated_icon","mainIconImg")),$("#toggleEraser img").replaceWith(Eink.getIconImg("pencil_icon")),$("#selectionErase img").replaceWith(Eink.getIconImg("selection_erase")),this.eink.painter.selectionMode=!1),$("#mainIconImg").css("border-color",t),$("#mainIconImg").css("border-width",o),this.view.eraseMode=!this.view.eraseMode,this.eink.painter.mode="draw"===this.eink.painter.mode?"erase":"draw",this.toggleSubmenu(e)},changeHighlightColor(e){if(e.stopPropagation(),!e.target.closest("#mainIcon")){const t=e.target.firstElementChild.style.borderColor,o=document.getElementById("mainIconImg").style.borderColor;let n;"gray"===this.getColorName(t)?$("#mainIconImg").replaceWith(Eink.getIconImg("eraserActivated_icon","mainIconImg")):$("#mainIconImg").replaceWith(Eink.getIconImg(`${this.getColorName(t)}MarkPen_icon`,"mainIconImg")),this.eink.highlighter.highlightColor=t,$("#mainIconImg").css("border-color",t),n="gray"===this.getColorName(o)?Eink.getIconImg("eraser_icon"):Eink.getIconImg(`${this.getColorName(o)}MarkPen_icon`),n.style.borderColor=o,$(e.target.firstElementChild).replaceWith(n)}e.type&&this.toggleSubmenu(e)},exitDraw:e=>{e?.stopPropagation(),this.painter.disableDraw(),this.mode="eink.read",this.#I(),this.onexitdraw(),this.onSwitchMode({mode:"eink.read"})},exitHighlight:e=>{e?.stopPropagation(),this.#I(),this.highlighter.highlightAreas.forEach((e=>{e&&($(e).off(".highlight"),e.classList.remove("no-select"))})),this.highlighter.highlightAreas=[],this.floatToolBar.view.submenuOn&&this.floatToolBar.toggleSubmenu(),$(this.floatToolBar.view).hide(),this.books.forEach((e=>{e.preventTouchEnd=!1})),this.mode=this.noteBook?.book.isVisible?"eink.notebook":"eink.read",this.onexithighlight(),this.onSwitchMode({mode:"eink.read"})},makeTool:(e,t,o)=>({icon:e,func:t,name:o})}}