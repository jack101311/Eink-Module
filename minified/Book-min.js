class Book{container=document.documentElement;contents=document.body.childNodes;bookConfig={};lang=void 0;bookEditor=new BookEditor(this);bookTitle=void 0;author=void 0;contentTable=null;noteSection=null;notes=[];fillers=[];pageStarters=[];pageStarter=null;static textSelection="";static focusedBook=null;instanceID=0;mode="scroll";containerHeight=0;containerWidth=0;pageHeight=0;pageWidth=0;pageLength=0;totalPages=1;inIOSBrowser=void 0;isLarge=!1;originalFontSize=void 0;preventFlip=!1;ignoreMutation=!1;preventGestures=!1;onentereink=()=>{};onenterscroll=()=>{};onbookresize=()=>{};onbookreset=()=>{};onpagechange=()=>{};onbookend=()=>{};onbookstart=()=>{};onvisible=()=>{};static#t=1;static#e=!1;static#n=!1;static#i=2;static#o=!1;#s=1;#r=0;#a=null;#l=null;#h=null;#c=0;#d=null;#g=void 0;#u=!1;#p=void 0;#f=!1;#m=["bookreset","pagechange","bookend","bookresize","entereink","enterscroll","bookstart","visible","hidden"];#b=[];#k=0;#x=!1;#E=!1;#S=!1;#y=0;#C=!1;#v=!1;#N=null;#T=!1;#w=null;#P=0;#B=0;#M=null;#$=0;#I=[];#L=[];#_=null;#D="";#H=null;#R=null;#O=0;floatingElements=[];testDifference=[];failCount=0;constructor(t=document.body,e={}){if(this.instanceID=Book.#t,Book.#t++,this.container="HTML"===t.nodeName?document.body:t,this.bookConfig={...Book.prototype.bookConfig,...e},this.contents="string"==typeof this.bookConfig.contents?$(this.bookConfig.contents)[0]:this.bookConfig.contents,!this.contents){let t=$(this.container).find(" > .bookContents")[0];this.contents=t||this.container}this.container.classList.add("book"),this.container.classList.add("book_"+this.instanceID),this.container.book=this,this.#r=2*this.bookConfig.leftMargin,this.bookConfig.bookTitle?this.bookTitle=$(this.bookConfig.bookTitle)[0]:this.bookTitle=this.getBookTitle(),this.author=this.bookConfig.author,this.bookConfig.lang?this.lang=this.bookConfig.lang:this.lang=document.documentElement.lang.includes("zh")?"zh-TW":"en","column"===this.bookConfig.pagingMethod&&(this.bookConfig.rightMargin=this.bookConfig.leftMargin),this.bookConfig.fullScreen="BODY"===this.container.nodeName||this.bookConfig.fullScreen,!this.isFullScreen&&Book.focusedBook||this.getFocus(),this.contents===this.container?($(this.container).wrapInner(`<div class="bookContents article_${this.instanceID}"></div>`),this.contents=this.container.firstElementChild,$(this.contents).css({width:"100%",height:"100%"})):(this.contents.classList.add("bookContents"),this.contents.classList.add(`article_${this.instanceID}`)),this.contents.book=this,this.inIOSBrowser=(()=>{const t=navigator.userAgent||navigator.vendor||window.opera;return!(!/iPad|iPhone|iPod/.test(t)||window.MSStream)||!(!/Mac/.test(t)||!("ontouchend"in document))})(),this.pageStarter=this.#F(this.contents,0),this.originalFontSize=parseFloat($(this.contents).css("font-size")),this.#g=parseFloat($(this.contents).css("line-height")),this.#W(),this.#p=Book.getOrientationState(),this.noteSystem.init(this.lang),this.bookConfig.useContentTable&&this.setupContentTable(),Book.#e||(Book.setupGlobalListeners(),Book.#e=!0)}#W(){this.isVisible?this.isFullScreen?(this.containerWidth=window.innerWidth,this.containerHeight=window.innerHeight):(this.containerWidth=this.container.clientWidth,this.containerHeight=this.container.clientHeight):(this.containerWidth=0,this.containerHeight=0)}get edittingPageEnd(){return this.#y}set edittingPageEnd(t){this.#y=t,this.#O=Math.round((this.#y+this.bookConfig.lowerMargin)/this.pageHeight)}get isVisible(){return 0!==this.container.clientWidth&&0!==this.container.clientHeight&&"visible"===$(this.container).css("visibility")}get mode(){return"eink"===sessionStorage.mode?"eink":"scroll"}get isFocused(){return Book.focusedBook===this}get isFullScreen(){return this.bookConfig.fullScreen}get bookItem(){return this.item(".bookItem")}get bookUI(){return this.item(".bookUI")}get scrollLengthChanged(){return!!this.isVisible&&("vertical"===this.bookConfig.pagingMethod?Math.abs(this.container.scrollHeight-this.#k)>2:Math.abs(this.container.scrollWidth-this.#k)>2)}get currentPage(){return this.#s}getFocus(){Book.focusedBook=this}getBlur(){const t=$(".book").filter(((t,e)=>$(e).is($(this.container).parents())&&e.book?.isVisible))[0]?.book;Book.focusedBook=t||$(".book").filter(((t,e)=>e.book?.isVisible))[0].book}getBookTitle(){let t=1,e=document.getElementsByTagName("H"+t)[0];for(;!e;)t++,e=document.getElementsByTagName("H"+t)[0];return e}static getOrientationState(){return window.innerWidth>window.innerHeight?"landscape":"portrait"}getPageStarter(t=this.pageWidth/2,e=10){let{offsetNode:n,offset:i}=this.#z(this.contents.offsetLeft+t,this.contents.offsetTop+e);if((!n||n.nodeType!==Node.TEXT_NODE)&&Math.abs(this.getPageNumByItem(n)-this.currentPage)>1){let o=n,s=t,r=e;for(;n===o&&Math.abs(this.getPageNumByItem(n)-this.currentPage)>1&&(o=n,s+=30,!(s>this.pageWidth&&(s=0,r+=30,r>this.pageHeight)))&&(({offsetNode:n,offset:i}=this.#z(this.contents.offsetLeft+s,this.contents.offsetTop+r)),n););}let o=this.#F(n,i);if(n){if("column"===this.bookConfig.pagingMethod)return o;if(this.isValidNode(n)){let t=n;for(;t.className?.includes("filler");)t=t.nextSibling;return this.#F(t,0)}return this.#F(this.contents,0)}return this.#F(this.contents,0)}getPageEnder(t=this.pageWidth/2,e=this.pageHeight-10){let{offsetNode:n,offset:i}=this.#z(this.contents.offsetLeft+t,this.contents.offsetTop+e);if((!n||n.nodeType!==Node.TEXT_NODE)&&Math.abs(this.getPageNumByItem(n)-this.currentPage)>1){let o=t,s=e,r=n;for(;n===r&&Math.abs(this.getPageNumByItem(n)-this.currentPage)>1&&(r=n,o-=30,!(o<0&&(o=this.pageWidth,s-=30,s<0)));)({offsetNode:n,offset:i}=this.#z(this.contents.offsetLeft+o,this.contents.offsetTop+s))}let o=this.#F(n,i);if(n){if("column"===this.bookConfig.pagingMethod)return o;if(this.isValidNode(n)){let t=n;for(;t.className?.includes("filler");)t=t.previousSibling;return this.#F(t,t.textContent?.length||0)}return this.#F(this.contents,this.contents.childNodes.length)}return this.#F(this.contents,this.contents.childNodes.length)}#A(t=1,e=this.totalPages){this.#M=this.currentPage,this.#_=this.contents;let n=this.contents.cloneNode(!0);this.contents.replaceWith(n),this.contents=$(this.container).find(".article_"+this.instanceID)[0],this.currentPage=t;performance.now();for(;this.currentPage<e;)this.#V(),this.currentPage++;this.#V();const i="vertical"===this.bookConfig.pagingMethod?this.container.scrollHeight:this.container.scrollWidth;this.#D=this.instanceID+"_"+Math.round(this.container.clientWidth)+"_"+Math.round(this.container.clientHeight)+"_"+parseInt($(this.contents).css("font-size"))+"_"+i;let o=[];this.#I.forEach((t=>{t.breakHeadMargin=t.startContainer.nodeType===Node.TEXT_NODE,t.breakTailMargin=t.endContainer.nodeType===Node.TEXT_NODE,t.extractContents(),t.insertNode(t.pageSection),o.push(t.pageSection)})),this.#L.push([this.#D,o,n]),$(this.contents).find("*").filter((function(){return Book.isElementEmpty(this)})).remove(),this.#I.forEach(((t,e)=>{const n=t.pageSection;if(e<this.#I.length-1){const n=this.#I[e+1].pageSection.querySelector("li:first-of-type");n&&t.pageSection.dataset.nextOlStart&&n.closest("ol")?.setAttribute("start",t.pageSection.dataset.nextOlStart)}let i=n.parentElement;for(;1===i?.children.length;){const t=i.cloneNode(!1);t.append(...n.childNodes),n.append(t),$(n).unwrap(),i=n.parentElement}if(t.breakHeadMargin){let t=n.firstElementChild;for(;t;)$(t).css({"border-top":"0px","margin-top":"0px","padding-top":"0px"}),t=t.firstElementChild}if(t.breakTailMargin){let t=n.lastElementChild;for(;t;)$(t).css({"border-bottom":"0px","margin-bottom":"0px","padding-bottom":"0px"}),t=t.lastElementChild}const o="draw"+(e+1)+"_"+this.#D,s=document.getElementById(o);s&&(t.pageSection.canvas=s,s.top=$(s).css("top"),s.left=$(s).css("left"),$(s).css({top:-1*this.bookConfig.upperMargin+"px",left:-1*this.bookConfig.leftMargin+"px",display:"block",position:"absolute"}),n.appendChild(s))}));performance.now();this.setupEinkStyle(`\n        .page-section {\n          break-before: page;\n          display: block;\n          position: relative;\n          margin-top: ${this.bookConfig.upperMargin}px;\n          margin-bottom: ${this.bookConfig.lowerMargin}px;\n          width: ${this.pageWidth}px;\n          height: ${this.pageHeight}px;\n        }\n      `,!1),$(".page-section").first().css({"margin-top":"0px","break-before":"avoid"})}static isElementEmpty(t){if(["img","canvas","svg","input","iframe","area","base","col","embed","hr","link","source","param"].includes(t.nodeName.toLowerCase()))return!1;if(""!==t.textContent.trim())return!1;for(let e of t.children)if(!Book.isElementEmpty(e))return!1;return!0}#X(){const t=this.getPageStarter(0);if(t.starter.nodeType===Node.ELEMENT_NODE)"A"===t.starter.nodeName&&$(t.starter).css("display","block"),t.starter.classList.add("pageStarter");else{let e=t.starter.parentElement;if("inline"===$(e).css("display")){for(e=e.parentElement;"inline"===$(e).css("display");)e=e.parentElement;const n=Book.rangeTool.createRange(t.starter,e,t.offset,e.childNodes.length),i=document.createElement("span");i.classList.add("pageBreaker");const o=n.extractContents();i.appendChild(o),n.insertNode(i)}else{const e=Book.rangeTool.createRange(t.starter,t.starter,t.offset,t.offset),n=document.createElement("span");n.classList.add("pageBreaker"),n.classList.add("pageStarter"),e.surroundContents(n)}}this.pageStarters.push(t)}#V(){const t=this.getPageStarter(0),e=this.getPageEnder(this.pageWidth-10),n=Book.rangeTool.createRange(t.starter,e.starter,t.offset,e.offset),i=document.createElement("pagesection");i.classList.add("page-section"),i.dataset.pageNumber=this.currentPage;let o=n.cloneContents(),s=o.querySelector("ol:last-of-type");if(o.firstElementChild===s&&(s=null),s){let t=1;const e=s.querySelector("li:last-of-type");e.parentElement===s&&(t=Array.from(s.children).indexOf(e)+2),i.dataset.nextOlStart=t}i.appendChild(o),$(i).find("*").filter(((t,e)=>e.nodeType===Node.TEXT_NODE&&""===e.textContent.trim())).remove(),n.pageSection=i,this.#I.push(n)}#z(t,e){const n=this.container.getBoundingClientRect().left+t,i=this.container.getBoundingClientRect().top+e;let o=[],s=document.elementFromPoint(n,i);for(;s&&(!s.book||s.book!==this)&&s.closest(".article_"+this.instanceID)!==this.contents&&!["HTML","BODY"].includes(s.tagName);)"static"!==$(s).css("position")?(s.style.pointerEvents="none",o.push(s)):(s.offsetParent.style.pointerEvents="none",o.push(s.offsetParent)),s=document.elementFromPoint(n,i);let r=this.#j(n,i);return o.forEach((t=>{t.style.pointerEvents=""})),r?{offsetNode:r.offsetNode,offset:r.offset}:{offsetNode:null,offset:null}}#j(t,e){if(document.caretPositionFromPoint){const n=document.caretPositionFromPoint(t,e);if(n)return{offsetNode:n.offsetNode,offset:n.offset}}else if(document.caretRangeFromPoint){const n=document.caretRangeFromPoint(t,e);if(n)return{offsetNode:n.startContainer,offset:n.startOffset}}return null}getScrollPosition(t){if(t){const e=t.getBoundingClientRect(),n=this.container.getBoundingClientRect();return{x:Math.round(e.left-n.left+this.container.scrollLeft),y:Math.round(e.top-n.top+this.container.scrollTop)}}return{x:"vertical"===this.bookConfig.pagingMethod?Math.round(this.container.scrollLeft):Math.round(this.container.scrollLeft+this.bookConfig.leftMargin),y:Math.round(this.container.scrollTop)}}set currentPage(t){const e=this.#s,n="vertical"===this.bookConfig.pagingMethod?"scrollTop":"scrollLeft";if(t===this.#s&&Math.round(this.container[n])%this.pageLength<1)return;let i;t>=1&&t<this.totalPages?(this.#x=!1,t===this.#s+1||this.#s,this.#s=t):t>=this.totalPages?(this.#s=this.totalPages,this.#x=!0):(this.#s=1,this.#x=!1),this.container[n]=this.pageLength*(this.#s-1),"column"===this.bookConfig.pagingMethod&&($(this.container).find("> *").not($(this.contents)).not(".draw").each(((t,e)=>{const n=$(e).css("position");["static","relative"].includes(n)?this.bookEditor.changeStyle(e,{position:"relative",left:this.pageLength*(this.#s-1)+"px"}):"absolute"===n&&(e.originalLeft||(e.originalLeft=parseFloat($(e).css("left"))),this.bookEditor.changeStyle(e,{left:e.originalLeft+this.pageLength*(this.#s-1)+"px",width:e.clientWidth+30+"px"}))})),this.container.scrollTop=0),this.pageStarter=this.getPageStarter(),sessionStorage.setItem("pageNumBook"+this.instanceID,this.#s.toString()),$("#pageNumDiv_"+this.instanceID).text(this.currentPage+"/"+this.totalPages),i=t-e==1?"next":t-e==-1?"prev":"jump",this.#q("pagechange",{book:this,startPageNum:e,endPageNum:this.#s,direction:i})}enterEinkMode(){this.mode="eink",sessionStorage.getItem("pageNumBook"+this.instanceID)||(this.#w=this.#G()),this.isFullScreen&&0!==document.documentElement.scrollTop&&(Book.#o=!0),this.setupEinkStyle(),this.#K(),this.setupListeners(),this.container.classList.add("disable-default-touch"),this.isVisible&&this.#U(this.#w),this.#q("entereink"),this.#N=performance.now()}#U(t){let e;null===t?(e=Number(sessionStorage.getItem("pageNumBook"+this.instanceID)),this.currentPage=e):(e=this.getPageNumByItem(t),this.currentPage=e)}quickPreview(t,e,n){const i=this.currentPage;this.currentPage=t;const o=this.getPageStarter(0);this.currentPage=e;const s=this.getPageEnder(this.pageWidth);let r,a;if(t>1){const e=parseFloat($(this.contents).css("line-height"))?parseFloat($(this.contents).css("line-height")):12;this.currentPage=t-1,r=this.getPageEnder(0,3*e)}else r=o;e<this.totalPages?(this.currentPage=e+1,a=this.getPageStarter(0)):a=s,this.currentPage=i;const l=Book.rangeTool.createRange(o.starter,s.starter,o.offset,s.offset),h=document.createElement("div");let c;h.className="previewSection",h.appendChild(l.cloneContents()),this.container.append(h),this.isFullScreen?c=new Book(h,{useNotes:!1,useContentTable:!1}):($(h).css({width:this.contents.clientWidth+"px",height:this.contents.clientHeight+"px"}),c=new Book(h,{useNotes:!1,leftMargin:0,rightMargin:0,upperMargin:0,lowerMargin:0,fullScreen:!1,contentTableConfig:{useContentTable:!1}}));const d=parseFloat($(this.contents).css("font-size"));if($(c.contents).css("font-size",d+"px"),Book.einkBroFontSizeAdjustment(c.contents,d),c.changeFontSizeBy(n),c.enterEinkMode(),c.previewRange=l,c.previewRange.head=r,c.previewRange.tail=a,$("#pageNumDiv_"+c.instanceID).text(c.currentPage+(t-1)+"/"+this.totalPages),c.addEventListener("pagechange",(()=>{sessionStorage.setItem("pageNumBook"+c.instanceID,""),$("#pageNumDiv_"+c.instanceID).text(c.currentPage+(t-1)+"/"+this.totalPages)})),!c.isFullScreen){const{top:t,left:e}=this.contents.getBoundingClientRect();$(c.container).css({position:"fixed",left:e+"px",top:t+"px"})}return c.onbookreset=()=>{if(!c.isFullScreen){const{top:t,left:e}=this.contents.getBoundingClientRect();$(c.container).css({position:"fixed",left:e+"px",top:t+"px"})}$("#pageNumDiv_"+c.instanceID).text(c.currentPage+(t-1)+"/"+this.totalPages)},this.preview=c,c}#G(){let t=null;const e=this.container.getBoundingClientRect().top>=0?this.container.getBoundingClientRect().top:0;return $(this.contents).find("*").each(((n,i)=>{if(!this.isValidNode(i))return!0;const o=i.getBoundingClientRect().top;return o>=e&&o<1/0?(t=i,!1):void 0})),t}setupEinkStyle(t="",e=!0){e&&(this.bookConfig.einkStyle+=t);let n=document.getElementById("einkStyle_book"+this.instanceID);n||(n=document.createElement("style"),n.id="einkStyle_book"+this.instanceID,document.head.appendChild(n));n.textContent=this.bookConfig.einkStyle+"\n     .pageNumDiv {\n      z-Index: 30;\n      font-size: 10px;\n      line-height: 1.5;\n      color: dimgray;\n      margin: 0px;\n      display: block;\n     }\n\n      @media print {\n        .pageNumDiv {\n          display: none;\n        }\n      }\n\n      .no-select {\n        -webkit-user-select: none;  /* Safari */\n          -moz-user-select: none;  /* Firefox */\n            -ms-user-select: none;  /* Internet Explorer/Edge */\n                user-select: none;  /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */\n      }\n\n      .disable-default-touch {\n        touch-action: none;\n      }\n    "+(e?"":t)}setupListeners(){this.#Y(),$(window).on("resize.book"+this.instanceID,(()=>{"eink"===this.mode&&(this.#c++,this.#u=!0,this.isVisible&&(this.ignoreMutation=!0,$(this.container).css("width",this.containerWidth+"px"),$(this.container).css("height",this.containerHeight+"px")),Book.#o=!0,this.#Q())})),this.#Z(),this.addEventListener("click",this.#J),this.addEventListener("scroll",this.#tt),this.addEventListener("touchstart",this.#et),this.addEventListener("touchend touchcancel",this.#nt),"ontouchstart"in window&&!this.inIOSBrowser&&(this.#d=window.setInterval((()=>{this.scrollLengthChanged&&this.resetPages()}),1500))}static setupGlobalListeners(){$(window).on("keydown.book",Book.#it),document.onselectionchange=()=>{Book.textSelection=window.getSelection().toString()},document.documentElement.scrollTop=Book.#i/2,$(window).on("scroll.book",Book.#ot)}#J(t){const e=t.target.closest(".book").book;e!==this||this.isFocused||(this.getFocus(),t.stopPropagation());const n=t.target.closest("a[href]"),i=t.target.closest(".bookUI");if(e===this)if(n&&!i)if(t.target.href?.includes("#")){const e=t.target.href.slice(t.target.href.indexOf("#"));"column"===this.bookConfig.pagingMethod&&(t.preventDefault(),this.currentPage=this.getPageNumByItem($(e)[0]),this.hint(e))}else t.preventDefault(),e===this&&this.#st(t);else i&&this.container.contains(i)||this.#st(t)}hint(t){this.ignoreMutation=2,this.preventFlip=!0,"string"==typeof t?t=$(t)[0]:"object"==typeof t&&("starter"in t?t=t.starter.nodeType===Node.TEXT_NODE?Book.rangeTool.createRange(t.starter,t.starter,t.offset,t.starter.length):t.starter:t.nodeType===Node.TEXT_NODE&&(t=Book.nodeTool.createRange(t,t,0,t.textContent.length)));const e=document.createElement("SPAN");let n;e.style.backgroundColor="yellow",t.nodeType===Node.ELEMENT_NODE?(n=$(t).css("background-color"),$(t).css("background-color","yellow")):t.surroundContents(e);const i=document.createElement("DIV");i.textContent="zh-TW"===this.lang?"繼續閱讀":"continue reading",i.id="hintMessage",i.style.cssText="\n      position: fixed;\n      background-color: rgba(0, 0, 255);\n      color: white;\n      padding: 5px 10px;\n      border-radius: 5px;\n      font-size: 14px;\n      z-index: 9999;\n    ";const o=document.createElement("DIV");o.style.cssText="\n      width: 0;\n      height: 0;\n      border-left: 8px solid transparent;\n      border-right: 8px solid transparent;\n      position: absolute;\n    ";const s=(t.nodeType===Node.ELEMENT_NODE?t:e).getClientRects()[0];if(!s)return;const r=s.top,a=window.innerHeight-s.bottom;r>=40?(i.style.bottom=window.innerHeight-s.top+10+"px",i.style.left=`${s.left}px`,o.style.borderTop="8px solid rgba(0, 0, 255)",o.style.bottom="-8px",o.style.left="10px"):a>=this.bookConfig.lowerMargin+40?(i.style.top=`${s.bottom+10}px`,i.style.left=`${s.left}px`,o.style.borderBottom="8px solid rgba(0, 0, 255)",o.style.top="-8px",o.style.left="10px"):s.left>window.innerWidth/2?(i.style.right=window.innerWidth-s.left+10+"px",i.style.top=`${s.top}px`,o.style.borderRight="8px solid rgba(0, 0, 255)",o.style.left="-8px",o.style.top="5px"):(i.style.left=`${s.right+10}px`,i.style.top=`${s.top}px`,o.style.borderLeft="8px solid rgba(0, 0, 255)",o.style.right="-8px",o.style.top="5px"),i.appendChild(o),document.documentElement.appendChild(i),$("greenmark, bluemark, redmark").css("background-color","transparent");const l=()=>{if($("greenmark, bluemark, redmark").css("background-color",""),"collapsed"in t){const t=e.parentElement;t&&(e.outerHTML=e.innerHTML,t.normalize())}else $(t).css("background-color",n);i&&i.remove()},h=window.setTimeout((()=>{l(),this.preventFlip=!1}),3e3),c=performance.now();$(window).on("click.hint",(()=>{performance.now()-c>1e3&&(clearTimeout(h),l(),this.preventFlip=!1,$(window).off("click.hint"))}))}#tt(t){const e="vertical"===this.bookConfig.pagingMethod?this.getScrollPosition().y:this.getScrollPosition().x,n=this.pageLength;let i=e;e%n<3?i=e-e%n:e%n>n-3&&(i=e-e%n+n),t.timeStamp<3e3?this.currentPage=parseInt(sessionStorage.getItem("pageNumBook"+this.instanceID)):!0===this.#T?(this.#U(this.#w),this.#T=!1):!0!==this.#x?(this.currentPage=this.getPageNumByScrollPos(i),1===this.currentPage&&this.#q("bookstart")):(this.#x=!1,this.#q("bookend"))}item(t=""){return $(this.contents).find(t).filter(((t,e)=>e.closest(".book").book===this&&this.isValidNode(e)))}#K(t=!1){const e=performance.now();if(this.#E||$(this.contents).find("img").css({"max-width":"100%",height:"auto","object-fit":"contain"}),!1===this.isVisible)return void(this.#f=!0);if($(this.contents).find("br").remove(),"vertical"===this.bookConfig.pagingMethod){for(this.pageWidth=this.contents.clientWidth,this.pageHeight=this.container.clientHeight,this.pageLength=this.container.clientHeight,$("#manual").css("pointer-events","none"),this.container.scrollTop=0;Math.abs(this.container.scrollTop-(this.container.scrollHeight-this.pageHeight))>3&&!this.#S;)this.#rt(),this.container.scrollTop+=this.pageHeight;this.#S=!1,this.container.scrollTop=0,$("#manual").css("pointer-events","auto"),this.pageStarters=[this.#F(this.contents)]}else"column"===this.bookConfig.pagingMethod&&this.#at();this.#s=1,this.handleBookEnd(),this.#lt(),this.#k="vertical"===this.bookConfig.pagingMethod?this.container.scrollHeight:this.container.scrollWidth;performance.now()-e>150&&(this.isLarge=!0)}changeFontSizeBy(t){const e=this.contents,n=parseFloat(getComputedStyle(e).fontSize)+t;e.hasAttribute("data-font-adjusted")||($(e).find("*").each((function(){const t=$(this),e=Math.round(parseFloat(t.css("font-size"))/parseFloat(t.parent().css("font-size"))*100)/100;t.css({"font-size":`${e}em`})})),e.setAttribute("data-font-adjusted","true")),$(e).css("font-size",`${n}px`),Book.einkBroFontSizeAdjustment(e,n),n===this.originalFontSize?($(e).css("line-height",this.#g+"px"),Book.einkBroLineHeightAdjustment(e,this.#g)):$(e).css("line-height","1.5")}static einkBroFontSizeAdjustment(t,e){if($(t).css("font-size")!==e+"px"){const n=parseFloat($(t).css("font-size"))/e;$(t).css("font-size",e/n+"px")}}static einkBroLineHeightAdjustment(t,e){if($(t).css("line-height")!==e+"px"){const n=parseFloat($(t).css("line-height"))/e;$(t).css("line-height",e/n+"px")}}#at(){this.bookItem.each((function(){const t=this.querySelector("img")||this.querySelector("iframe");this.media=t,this.originalHeight=this.clientHeight,t&&(t.originalHeight=t.clientHeight)}));const t=1===$(this.container).find(" > *:visible").filter((function(){return"static"===$(this).css("position")||"relative"===$(this).css("position")})).length,{topMargin:e,bottomMargin:n}=this.#ht(this.contents);if(this.bookConfig.fullScreen){const{vw:i,vh:o}=this.#ct();this.bookEditor.changeStyle(document.documentElement,{margin:"0px",border:"0px",padding:"0px",backgroundColor:"white",height:window.innerHeight+Book.#i+"px",overflow:"scroll",scrollbarWidth:"none"}),this.bookEditor.changeStyle(this.container,{position:"fixed",top:"0px",left:"0px",margin:"0px",paddingTop:`${this.bookConfig.upperMargin}px`,paddingBottom:`${this.bookConfig.lowerMargin}px`,paddingLeft:`${this.bookConfig.leftMargin}px`,paddingRight:`${this.bookConfig.rightMargin}px`,zIndex:this.bookConfig.zIndex+(1e3+this.instanceID),backgroundColor:"white",boxSizing:"border-box",overflow:"hidden"},!1),this.bookEditor.changeStyle(this.container,{height:window.innerHeight/o*100+"vh",width:window.innerWidth/i*100+"vw"},!1),this.bookEditor.changeStyle(this.contents,{display:"block",height:this.contents.clientHeight+"px",width:this.contents.clientWidth+"px","column-width":this.contents.clientWidth+"px","column-fit":"auto","column-gap":this.#r+"px",marginLeft:"0px",marginRight:"0px",marginTop:t?"0px":e+"px",marginBottom:t?"0px":n+"px",padding:"0px",border:"0px","background-color":"rgba(256 ,256 , 256, 0)"},!1)}else{const{vw:i,vh:o}=this.#ct();this.bookEditor.changeStyle(document.documentElement,{margin:"0px",border:"0px",padding:"0px",backgroundColor:"white",height:window.innerHeight+Book.#i+"px",overflow:"scroll",scrollbarWidth:"none"}),this.bookEditor.changeStyle(this.container,{position:"static"===$(this.container).css("position")?"relative":$(this.container).css("position"),paddingTop:`${this.bookConfig.upperMargin}px`,paddingBottom:`${this.bookConfig.lowerMargin}px`,paddingLeft:`${this.bookConfig.leftMargin}px`,paddingRight:`${this.bookConfig.rightMargin}px`,zIndex:this.bookConfig.zIndex+(1e3+this.instanceID),"background-color":"white","box-sizing":"border-box",overflow:"hidden"},!1);const s=this.container.clientHeight>window.innerHeight?window.innerHeight/o*100+"vh":this.container.clientHeight/o*100+"vh",r=this.container.clientWidth>window.innerWidth?window.innerWidth/i*100+"vw":this.container.clientWidth/i*100+"vw";this.bookEditor.changeStyle(this.container,{height:s,width:r},!1),this.bookEditor.changeStyle(this.contents,{display:"block",height:this.contents.clientHeight+1+"px",width:this.contents.clientWidth+"px","column-width":this.contents.clientWidth+"px","column-fit":"auto","column-gap":`${this.#r}px`,marginTop:t?"0px":e+"px",marginBottom:t?"0px":n+"px",marginLeft:"0px",marginRight:"0px",padding:"0px",border:"0px","background-color":"rgba(256 ,256 , 256, 0)"},!1)}let i=this.contents.firstElementChild;for(;i;)this.bookEditor.changeStyle(i,{"margin-top":"0px"}),i=i.firstElementChild;this.#dt(),this.bookItem.each(((t,e)=>{e.originalHeight=void 0,e.media&&(e.media.originalHeight=void 0)})),this.pageWidth=this.contents.clientWidth,this.pageHeight=this.contents.clientHeight,this.pageLength=this.contents.clientWidth+this.#r}#ht(t){const e=window.getComputedStyle(t),n=(t,e,i)=>{let o=parseFloat(window.getComputedStyle(t)[i]),s=t[e];for(;s;)o=Math.max(o,n(s,e,i)),s=s[e];return o};return{topMargin:Math.max(parseFloat(e.marginTop),n(t,"firstElementChild","marginTop")),bottomMargin:Math.max(parseFloat(e.marginBottom),n(t,"lastElementChild","marginBottom"))}}#ct(){const t=document.createElement("div");t.style.height="100vh",t.style.width="100vw",t.id="testDimensionDiv",this.container.appendChild(t);const e={vw:t.clientWidth,vh:t.clientHeight};return t.remove(),e}#dt(){const t=Array.from(this.bookItem);this.bookItem.css("break-inside","avoid"),t.forEach((t=>{if(t.getClientRects().length>1){let e=t.getClientRects()[0];const n=Math.round(this.contents.getBoundingClientRect().bottom-e.top),i=this.contents.clientHeight,o=t.media,s=t.originalHeight-Math.min(o?.clientHeight,o?.originalHeight)??0,r=3;n>=this.bookConfig.minImgHeight+s||Math.abs(n-i)<=r?this.bookEditor.changeStyle(o,{height:n-s-r+"px",width:"auto"},!1):t.originalHeight>i?this.bookEditor.changeStyle(o,{height:i-s-r+"px",width:"auto"},!1):this.bookEditor.changeStyle(o,{height:o.originalHeight+"px",width:"auto"},!1);let a=o.parentElement;for(;a&&a!==t;)this.bookEditor.changeStyle(a,{marginTop:"0px",paddingTop:"0px"},!1),a=a.parentElement}}))}#lt(){let t=document.getElementById("pageNumDiv_"+this.instanceID);t||(t=document.createElement("div"),t.classList.add("pageNumDiv"),t.id="pageNumDiv_"+this.instanceID,this.isFullScreen&&t.classList.add("fullScreen"),this.container.append(t),this.isFullScreen?this.bookEditor.changeStyle(t,{position:"fixed",right:"10px",bottom:"10px"},!0):this.bookEditor.changeStyle(t,{position:"relative",float:"right",clear:"both",bottom:"10px"},!0)),t.textContent=this.currentPage+"/"+this.totalPages}enterPrintMode(){if(this.mode="print",this.isVisible&&this.isFullScreen){this.removeEventListener();const t=this.#b;this.#b=[],this.#A(),this.container.classList.remove("disable-default-touch"),this.#H=this.container.parentNode,this.#R=this.container.nextSibling,document.documentElement.appendChild(this.container),Array.from(document.documentElement.children).forEach((t=>{t!==this.container&&(t.initState=$(t).css("display"),t.style.display="none")})),$("HTML").css({height:"",display:"flex",alignItems:"center",justifyContent:"space-evenly",overflow:"auto"}),$(this.container).css({height:"",position:"",border:"1px solid black"}),$(this.contents).css({columnWidth:"",height:""}),$("#pageNumDiv_"+this.instanceID).hide(),this.#b=t,this.#v=!0}}exitPrintMode(){this.#v&&(this.#R?this.#H.insertBefore(this.container,this.#R):this.#H.appendChild(this.container),Array.from(document.documentElement.children).forEach((t=>{t!==this.container&&$(t).css("display",t.initState)})),$(".eink").hide(),$(".draw").filter(((t,e)=>e.id.includes(this.#D))).each(((t,e)=>{$(e).css({position:"absolute",left:parseInt(e.id.slice(e.id.indexOf("w")+1,e.id.indexOf("_"))-1)*this.pageLength+"px",top:"0px"})})).appendTo(this.container),this.contents.replaceWith(this.#_),this.contents=this.#_,$("HTML").css({display:"block",alignItems:"",justifyContent:"",overflow:"scroll",height:window.innerHeight+100+"px"}),$(this.container).css({position:"fixed",height:this.#D.split("_")[2]+"px",border:""}),$(this.contents).css({columnWidth:this.pageWidth+"px",height:this.pageHeight+"px"}),$("#pageNumDiv_"+this.instanceID).show(),this.container.classList.add("disable-default-touch"),this.setupListeners(),this.#I=[],this.#D="",this.#_=null,this.#v=!1,this.currentPage=this.#M,this.#M=null,this.mode="eink")}#rt(){const{y:t}=this.container.getBoundingClientRect(),e=t+this.bookConfig.upperMargin,n=t+this.pageLength-this.bookConfig.lowerMargin,i=t+this.pageLength,o=t=>{const{offsetNode:e,offset:n}=this.#j(this.bookConfig.leftMargin,t);if(!e)return;let i=s(e,n);if(i&&this.isValidNode(i)){const e=r(i);e?a(e,t):l(i,t,n)}},s=(t,e)=>t.nodeType===Node.TEXT_NODE?t:t.nodeType!==Node.ELEMENT_NODE||t.closest(".filler")?void 0:t.childNodes[e]??t.childNodes[e-1],r=t=>t.closest?t.closest(".pageItem"):t.parentElement.closest(".pageItem"),a=(t,e)=>{if(e>=n)t.onCrossPage?t.onCrossPage():this.#gt(t);else{const n=Math.round(e-t.getBoundingClientRect().top);this.#ut(t,n+(e===i-1?this.bookConfig.upperMargin:0),e)}},l=(t,e,n)=>{t.nodeType===Node.TEXT_NODE?h(t,e,n):t.nodeType===Node.ELEMENT_NODE&&c(t,e)},h=(t,e,o)=>{if(t.parentElement.normalize(),null===t.parentElement){let n=this.#j(this.bookConfig.leftMargin,e);t=n.offsetNode,o=n.offset}let s,r=Book.rangeTool.createRange(t,t,o,t.length),a=Math.round(e-r.getBoundingClientRect().top);e>=n?(r.collapse(!0),s=this.#ut(r,this.bookConfig.upperMargin+this.bookConfig.lowerMargin+a,e)):s=this.#ut(t.parentElement,a+(e===i-1?this.bookConfig.upperMargin:0),e),s&&d(s)},c=(t,e)=>{if("IMG"===t.nodeName&&e>=n)this.#gt(t);else{const o=Math.round(e-t.getBoundingClientRect().top);this.#ut(t,o+(e>=n?this.bookConfig.upperMargin+this.bookConfig.lowerMargin:e===i-1?this.bookConfig.upperMargin:0),e)}},d=t=>{this.inIOSBrowser&&(t.style.display="inline-block");let e=t;for(;"A"===e.parentElement.nodeName||e.parentElement.getBoundingClientRect().top===t.getBoundingClientRect().top;)e=e.parentElement;e!==t&&e.insertAdjacentElement("beforebegin",t),this.inIOSBrowser&&(t.style.display="block")};o(e),o(n),o(i-1)}#gt(t){const e=["IMG","VIDEO","IFRAME"].includes(t.nodeName)?t:t.querySelector("img")||t.querySelector("video")||t.querySelector("iframe"),n=Math.round(this.pageLength-this.bookConfig.lowerMargin-t.getBoundingClientRect().top),i=this.pageLength-(this.bookConfig.upperMargin+this.bookConfig.lowerMargin),o=t.clientHeight-e.clientHeight;n>=this.bookConfig.minImgHeight+o||Math.abs(n-i)<=3?(this.bookEditor.changeStyle(e,{height:n-o-3+"px",width:"auto"},!1),this.bookEditor.changeStyle(t,{"margin-Bottom":this.bookConfig.upperMargin+this.bookConfig.lowerMargin+"px"},!1)):this.#ut(t,n+this.bookConfig.upperMargin+this.bookConfig.lowerMargin,this.pageHeight-this.bookConfig.lowerMargin)}#ut(t,e,n){if(e<=0)return null;const i=document.createElement("div");if(this.fillers.push(i),i.classList.add("filler_"+n),i.id="filler_"+this.fillers.length,i.style.marginTop="0px",i.style.marginBottom="0px",i.style.height=e+"px","startContainer"in t)t.surroundContents(i);else{t.insertAdjacentElement("beforebegin",i);do{this.bookEditor.changeStyle(t,{"margin-top":"0px"}),t=t.firstElementChild}while(t)}return i.previousSibling?.classList?.contains("filler_"+n)&&(this.#S=!0,i.previousSibling.remove(),i.remove()),i}handleBookEnd(){if("vertical"===this.bookConfig.pagingMethod)if(this.container.scrollHeight<this.edittingPageEnd+this.bookConfig.lowerMargin){const t=this.edittingPageEnd+this.bookConfig.lowerMargin-this.container.scrollHeight;this.bookEditor.addFiller(this.contents,t,"ending_filler","beforeend"),this.totalPages=Math.ceil(this.edittingPageEnd/this.pageLength)}else this.totalPages=Math.ceil(this.container.scrollHeight/this.pageLength);else if("column"===this.bookConfig.pagingMethod){const t=document.createElement("div");this.bookEditor.changeStyle(t,{height:this.pageHeight+"px",width:this.pageWidth+"px",margin:"0px",padding:"0px",border:"0px"},!0),this.contents.append(t),this.totalPages=Math.ceil(this.container.scrollWidth/this.pageLength)-1}}resetPages(){this.isVisible?(this.#a?.disconnect(),this.bookEditor.recoverAllEdits(),this.fillers.forEach((t=>{t.remove()})),this.#K(!0),this.pageStarter&&this.contents.contains(this.pageStarter.starter)?"#text"===this.pageStarter.starter.nodeName?this.currentPage=this.getPageNumByItem(Book.rangeTool.createRange(this.pageStarter.starter,this.pageStarter.starter,this.pageStarter.offset,this.pageStarter.starter.length)):this.currentPage=this.getPageNumByItem(this.pageStarter.starter):this.currentPage=1,this.#Y(),this.#f=!1,this.#q("bookreset")):this.#f=!0}enterScrollMode(){if(this.mode="scroll",this.removeEventListener(),this.bookEditor.recoverAllEdits(),this.fillers.forEach((t=>{t.remove()})),$(`#einkStyle_book${this.instanceID}`).remove(),this.#w=null,sessionStorage.setItem("pageNumBook"+this.instanceID,""),this.isVisible&&this.pageStarter)if(this.pageStarter.starter.nodeType===Node.ELEMENT_NODE)this.pageStarter.starter.scrollIntoView();else{("HTML"===this.container.nodeName||this.bookConfig.fullScreen?document.documentElement:this.container).scrollTop=Book.rangeTool.createRange(this.pageStarter.starter,this.pageStarter.starter,this.pageStarter.offset,this.pageStarter.starter.length).getBoundingClientRect().top+this.container.scrollTop}else this.container.scrollTop=0;this.container.classList.remove("disable-default-touch"),this.#q("enterscroll")}getPageNumByItem(t){let e,n,i=0;return"starter"in t&&(i=t.offset,t=t.starter),"vertical"===this.bookConfig.pagingMethod?(n="#text"===t.nodeName?Book.rangeTool.createRange(t,t,i,t.length).getBoundingClientRect():t.getBoundingClientRect(),e=Math.round(n.y-this.container.getBoundingClientRect().y+this.container.scrollTop)):"column"===this.bookConfig.pagingMethod&&(n="#text"===t.nodeName?Book.rangeTool.createRange(t,t,i,t.length).getBoundingClientRect():Array.from(t.getClientRects()).find((t=>t.height>10))??t.getBoundingClientRect(),e=Math.round(n.x-this.container.getBoundingClientRect().x+this.container.scrollLeft)),this.getPageNumByScrollPos(e)}#et(t){t.target.closest(".book").book===this&&(this.isFocused||(this.getFocus(),t.stopPropagation()),this.#P=t.touches[0].clientX,this.#B=t.touches[0].clientY,this.#$=t.touches.length)}#nt(t){if(this.#$){const e=()=>{this.#P=null,this.#B=null,this.#$=0};if(!this.#P||!this.#B)return;if(""!==window.getSelection()?.toString().trim()||!0===this.preventGestures)return void e();if(this.preventGestures)return this.preventGestures-=1,void e();if(1==this.#$){const e=t.changedTouches[0].clientX,n=t.changedTouches[0].clientY,i=e-this.#P,o=n-this.#B,s=50;Math.abs(i)<s&&o<-s?this.currentPage=1:Math.abs(i)<s&&o>s&&(this.currentPage=this.totalPages)}e()}}static#it(t){const e=Book.focusedBook;if("eink"===e?.mode)switch(t.key){case"ArrowRight":e.currentPage+=1;break;case"ArrowLeft":e.currentPage-=1;break;case"ArrowUp":e.currentPage=1;break;case"ArrowDown":e.currentPage=e.totalPages;break;case"AudioVolumeDown":e.currentPage+=1;break;case"AudioVolumeUp":e.currentPage-=1;break}}#Q(){if("scroll"===this.mode)return;if(!this.#u){if(!1===this.isVisible&&0!==this.containerWidth&&0!==this.containerHeight)return this.isFocused&&this.getBlur(),this.containerWidth=0,this.containerHeight=0,void this.#q("hidden");if(!0===this.isVisible&&0===this.containerWidth&&0===this.containerHeight)return this.getFocus(),this.#W(),this.#f&&(this.#f=!1,this.resetPages()),void this.#q("visible");if(this.containerWidth===this.container.clientWidth&&this.containerHeight===this.container.clientHeight)return}let t;this.#u=!1,null!==this.#N&&(t=performance.now()-this.#N,this.#N=null),clearTimeout(this.#h),this.#q("bookresize");this.#p!==Book.getOrientationState()&&this.#c<5?(this.#pt(t),this.#p=Book.getOrientationState(),this.#c=0):this.#h=setTimeout((()=>{this.#c=0,this.#pt(t)}),250)}#pt(t){this.#W(),this.ignoreMutation=!1,this.resetPages()}findContTablePage(){return this.contentTable?this.getPageNumByItem($(this.contentTable).find(":header")[0]):null}#st(t){if(""!==Book.textSelection?.trim())return;if(!0===this.preventFlip)return;if(this.preventFlip)return void(this.preventFlip-=1);const e=this.container.clientWidth/2,n=Math.round(this.container.getBoundingClientRect().x);t.clientX<n+e?this.currentPage-=1:this.currentPage+=1}addEventListener(t,e){t.split(" ").forEach((t=>{if(this.#m.includes(t))this.#b.push([t,e]);else{const n=t=>{"eink"===this.mode&&e.call(this,t)};"resize"===t?$(window).on(t+".book"+this.instanceID,n):$(this.container).on(t+".book"+this.instanceID,n)}}))}static#ot(t){if(t.target!==document&&"eink"===Book.focusedBook.mode)if(Book.#o)Book.#o=!1,document.documentElement.scrollTop=Book.#i/2;else{const t=Math.round(document.documentElement.scrollTop);Book.#n?Book.#n=!1:(t>Book.#i/2?(Book.focusedBook.currentPage++,Book.#n=!0):t<Book.#i/2&&(Book.focusedBook.currentPage--,Book.#n=!0),document.documentElement.scrollTop=Book.#i/2)}}#q(t,e={}){this["on"+t]&&this["on"+t].call(this,e),this.#b.forEach((([n,i])=>{n===t&&i.call(this,e)}))}#Z(){this.#l=new ResizeObserver(this.#Q.bind(this)),this.#l.observe(this.container)}removeEventListener(t,e){if(t){t.split(" ").forEach((t=>{this.#m.includes(t)?this.#b=e?this.#b.filter((([n,i])=>n!==t||i!==e)):this.#b.filter((([e,n])=>e!==t)):(t.includes("touch")&&(this.#P=null,this.#B=null,this.#$=null),"resize"===t?this.#l?.disconnect():e?$(this.container).off(t+".book"+this.instanceID,e):$(this.container).off(t+".book"+this.instanceID))}))}else $(window).off(".book"+this.instanceID),$(this.container).off(".book"+this.instanceID),$(this.contents).off(".book"+this.instanceID),this.#a?.disconnect(),this.#l?.disconnect(),clearInterval(this.#d),0===$(".book").filter((function(){return void 0!==this.book})).length&&($(window).off(".book"),document.onselectionchange=void 0,Book.#e=!1),this.#P=null,this.#B=null,this.#$=null}#F(t,e=0){return{starter:t,offset:e}}getPageNumByScrollPos(t){return Math.floor(t/this.pageLength)+1}isValidNode(t){return!(![Node.ELEMENT_NODE,Node.TEXT_NODE].includes(t.nodeType)||function(t){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const e="static"===$(t).css("position"),n=function e(n){let i=n.offsetParent;if(!i||"BODY"===i.nodeName)return i;if(["TABLE","TD"].includes(t.offsetParent.nodeName)||["relative","absolute"].includes($(i).css("position"))&&["top","left","right","bottom"].every((t=>0===parseInt($(i).css(t)))))return i=e(i),i}(t),i=n&&n!==this.contents&&this.contents.contains(n);return!e||i}.call(this,t)||function(t){if(t.nodeType===Node.TEXT_NODE)return""===t.textContent.trim();if(t.nodeType===Node.ELEMENT_NODE){const{width:e,height:n}=t.getBoundingClientRect();return 0===e||0===n}return!0}(t))}static findFloatingElements(t){const e=[],n=t=>{if(t.nodeType===Node.ELEMENT_NODE){if("none"!==window.getComputedStyle(t).float)return e.push(t),void(t.id=`floating-${e.length}`);for(let e of t.children)n(e)}};return n(t),e}#Y(){this.#a=new MutationObserver(this.#ft.bind(this)),this.#a.observe(this.contents,{attributeFilter:["style","class","width","height","id"],attributes:!0,childList:!0,subtree:!0})}#ft(t){if("scroll"===this.mode)return;if(!0===this.ignoreMutation)return;if(this.ignoreMutation)return void(this.ignoreMutation-=1);t.some((t=>t.addedNodes.length>0||t.removedNodes.length>0))?t.every((t=>t.target.closest(".book")!==this.container))||function(t){return t.some((t=>{const{target:e,addedNodes:n,removedNodes:i}=t;return!!this.isValidNode(e)&&(n.length&&Array.from(n).some((t=>this.isValidNode(t)))||i.length&&Array.from(i).some((t=>this.isValidNode(t))))}))}.call(this,t)&&this.resetPages():this.scrollLengthChanged&&this.resetPages()}setupContentTable(t={}){const e={area:this.contents,expandSubLists:!1,lang:this.lang,minLevel:"h1",maxLevel:"h6",style:""},{area:n,expandSubLists:i,lang:o,minLevel:s,maxLevel:r,style:a}={...e,...t},l="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh61PrcDdc05urR5s9YBt-zsRGyk51SKcunC0Ha8sYECZK9aEX_EYKv5fe5au4ERFc83wYtbe5-G4tkM9bTtih-AzGh7-0GHBrm_xixoaBR0eSO2zuLWkQooXIaHims2Mk1g6_KKyoIrw/s320/25223.png",h="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhLS0VMZ5HkQS6wSuNLbo1a8uYSiiysarkQCKxLrH31AdFKDcC1_0klWP9FGtsa9_1tKu-NEX7SniBnDSIhzLBuvMpZ1vy8HIja-OKm6wXQme057NMMF1lJ8UJLklsP9VnRd2BspzQXAA/s200/25623.png",c=$(n).find(":header").not(this.bookTitle).filter(((t,e)=>!["true",!0].includes(e.getAttribute("ignoreTable"))&&this.isValidNode(e)&&Number(e.nodeName.slice(1))>=Number(s.slice(1))&&Number(e.nodeName.slice(1))<=Number(r.slice(1))));if(c.length<=3)return;let d=$(this.contents).find(".cont_table").filter(((t,e)=>e.closest(".article_"+this.instanceID)===this.contents))[0];d?(d.classList.add("cont_table_book_"+this.instanceID),$(n).find(":header").not(this.bookTitle).filter(((t,e)=>!["true",!0].includes(e.getAttribute("ignoreTable"))&&this.isValidNode(e)&&Number(e.nodeName.slice(1))>=Number(s.slice(1))&&Number(e.nodeName.slice(1))<=Number(r.slice(1)))).attr("id",null)):(d=document.createElement("DIV"),d.classList.add("cont_table"),d.classList.add("cont_table_book_"+this.instanceID),c[0].insertAdjacentElement("beforebegin",d)),this.contentTable=d,d.setupContentTable=this.setupContentTable.bind(this);let g=document.getElementById(`cont_table_style_book${this.instanceID}`);g||(g=document.createElement("style"),g.textContent=`\n    .book_${this.instanceID} .cont_table {\n        border-style: double;\n        margin: 30px 0px;\n        padding: 10px 5px 10px 40px;\n        width: 80%;\n    }\n\n    .book_${this.instanceID} .cont_table li img {\n        margin-left: 10px;\n    }\n\n    .book_${this.instanceID} .cont_table li img:hover,\n    .book_${this.instanceID} .cont_table li img:focus {\n        cursor: pointer;\n    }\n`+a,this.contents.insertAdjacentElement("beforebegin",g),g.id=`cont_table_style_book${this.instanceID}`);let u="<ul>";for(let t=0;t<c.length;t++){const e=Number(c[t].nodeName.slice(1));if(u+=`<li><a href="#book${this.instanceID}_topic${t}">${c[t].textContent}</a>`,c[t].setAttribute("id",`book${this.instanceID}_topic`+t),t!==c.length-1){const n=Number(c[t+1].nodeName.slice(1));if(e<n)for(let o=0;o<n-e;o++)0===o?!0===i||"true"===c[t].getAttribute("expand")?u+=`<img class="foldIcon" src="${l}" width="12px"/></li><ul>`:u+=`<img class="foldIcon" src="${h}" width="12px"/></li><ul style="display:none;">`:u+="<ul>";else if(e>n){u+="</li>";for(let t=0;t<e-n;t++)u+="</ul>"}else u+="</li>"}else for(let t=0;t<e;t++)u+="</ul>"}const p="zh-TW"===o?"目錄":"Table of Content";d.innerHTML=`<h3 ignoreTable="true">${p}</h3>`+u,$(d).find("ul ul").each((function(){""!==this.style.display&&"block"!==this.style.display||(this.parentElement.style.display="block")})),$(d).find("img.foldIcon").on("click",(function(t){t.stopPropagation();const e=t.currentTarget,n=e.parentElement.nextElementSibling;"none"==n.style.display?(n.style.display="block",e.setAttribute("src",l)):(n.style.display="none",e.setAttribute("src",h))}))}remove(t=!1){this.getBlur(),t?(this.removeEventListener(),$(`#einkStyle_book${this.instanceID}`).remove(),this.container.remove()):(this.enterScrollMode(),this.container.classList.remove("book"),this.#C?($(this.container).find(" > *").not(this.contents).remove(),$(this.container).append($(this.contents.childNodes)),$(this.contents).remove()):(this.contents.classList.remove("article_"+this.instanceID),delete this.contents.book),delete this.container.book),delete sessionStorage["pageNumBook"+this.instanceID];for(const t in this)delete this[t]}noteSystem={book:this,bookID:void 0,noteNumberTexts:[],noteWindow:void 0,keptNote:void 0,lang:void 0,init(t){if(this.lang=t||(document.documentElement.lang.includes("zh")?"zh-TW":"en"),this.noteNumberTexts=Array.from($(this.book.contents).find("i:contains('Note'), i:contains('註')").filter(((t,e)=>"U"===(e=e.closest("i")).previousElementSibling?.nodeName&&e.closest(".bookContents")===this.book.contents))),this.book.bookConfig.useNotes&&this.noteNumberTexts.length>0){this.bookID=this.book.instanceID,this.setupNotes(this.lang),this.noteWindow=this.renderView();const t=document.createElement("style");t.textContent="\n        div#note_window {\n          position: fixed;\n          margin: 0px;\n          top: 0px;\n          left: 0px;\n          align-items: center;\n          justify-content: center;\n          z-index: 1000;\n          width: 100%;\n          height: 100%;\n          overflow: auto;\n          background-color: rgba(0, 0, 0, 0.4);\n          display: none;\n      }\n      \n      div#note {\n          background-color: #fefefe;\n          padding: 30px;\n          border: 1px solid #888;\n          max-width: 800px;\n          width: 80%;\n          margin: 10% auto;\n          overflow: auto;\n          border-radius: 20px;\n          box-sizing: border-box;\n      }\n      \n      div#note_content {\n          color: black;\n          font: 18px Roboto, sans-serif;\n          line-height: 1.6em;\n          letter-spacing: 0.8px;\n          display: block;\n      }\n      \n      #note_number {\n          margin: 0px;\n      }\n      \n      .noted_text {\n          background-color: yellow;\n      }\n      \n      #closeIcon {\n          color: #000;\n          float: right;\n          font-size: 28px;\n          font-weight: bold;\n          z-index: 1;\n      }\n      #closeIcon:hover,\n      #closeIcon:focus {\n          color: blue;\n          text-decoration: none;\n          cursor: pointer;\n      }\n\n      div#goToNotesBtn {\n        float: right;\n        font-size: 12px;\n        color: blue;\n        clear: both;\n        margin: 0px;\n      }\n\n      #goToNotesBtn:hover,\n      #goToNotesBtn:focus {\n          color: black;\n          text-decoration: none;\n          cursor: pointer;\n      }\n\n      i {\n        font-size: x-small;\n        font-style: normal;\n        font-weight: bold;\n        color: blue;\n        text-decoration: underline;\n        text-decoration-color: blue;\n        text-decoration-style: dotted;\n      }\n\n      i:hover,\n      i:focus {\n        color: black;\n        text-decoration: none;\n        cursor: pointer;\n      }\n\n      .checkNotedTextBtn {\n        cursor: pointer;\n        padding-left: 10px;\n      }\n\n      u {\n        text-decoration: none;\n      }\n        ",t.id=`note_style_sheet_book${this.book.instanceID}`,document.head.appendChild(t),this.noteWindow.addEventListener("click",(t=>{const e=t.target===this.noteWindow.closeIcon,n=t.target===this.noteWindow,i=t.target===this.noteWindow.goToNotesBtn;e||n?this.hideNoteWindow():i&&("scroll"===this.book.mode?window.location.href="#"+this.book.noteSection.id:(this.book.currentPage=this.book.getPageNumByItem(this.book.noteSection),this.book.hint(this.book.noteSection)),this.hideNoteWindow())})),this.book.container.addEventListener("click",(t=>{const e=t.target.closest("i[class*='noteButton']"),n=t.target.closest("[class*='checkNotedTextBtn']");e?this.displayNote(t):n&&this.checkNotedText(t)}))}},renderView(){const t=document.createElement("div"),e=document.createElement("div");t.id="note_window",t.classList.add("bookUI"),t.style.display="none",e.id="note",e.innerHTML=`<span id="closeIcon" class="bookUI">×</span><h3 id="note_number"></h3><div id="note_content"></div><div id="goToNotesBtn" class="bookUI">${"zh-TW"===this.lang?"註解區":"note section"}📄</div>`,t.appendChild(e),this.book.container.append(t),t.note=e,t.closeIcon=t.querySelector("#closeIcon"),t.noteNumber=t.querySelector("#note_number"),t.noteContent=t.querySelector("#note_content"),t.goToNotesBtn=t.querySelector("#goToNotesBtn");return t.book=new Book(t.note,{contents:t.noteContent,useContentTable:!1,einkStyle:"\n\n      div#note {\n        max-height: 80%;\n        overflow: hidden;\n      } \n\n      div#note_content {\n        width: 100%;\n        max-height: 75%;\n        margin-top: 10px;\n        margin-bottom: 0px;\n      }\n\n      div#goToNotesBtn {\n        position: relative;\n        margin-top: 10px;\n        top: -10px;\n      }\n      ",fullScreen:!1}),t.book.displayNote=this.displayNote.bind(this),t.book.hideNoteWindow=this.hideNoteWindow.bind(this),t},setupNotes(t="zh-TW"){const e="zh-TW"==t?"註解":"Notes",n=this.noteNumberTexts;$(n).each(((t,e)=>{e.id=`noteButton_${t+1}_${this.bookID}`,e.classList.add("noteButton"),e.classList.add("bookUI"),"U"===e.previousElementSibling?.nodeName&&(e.previousElementSibling.id=`notedText_${t+1}_${this.bookID}`)}));let i=$(this.book.contents).find(":header").filter((function(){return $(this).text().includes("Note ")||$(this).text().includes("註解")}))[0];if(i){i.parentElement.setAttribute("id","note_section_"+this.bookID),this.book.noteSection=i.parentElement;const t=$(`#note_section_${this.bookID} > p`).filter(((t,e)=>this.book.isValidNode(e)));t.length===n.length&&(this.book.notes=Array.from(t),o.call(this,t))}else(function(){let n="H6";$(this.book.contents).find(":header").each((function(){if(Number(this.nodeName.slice(1))<Number(n.slice(1))&&(n=this.nodeName,"H1"==n))return!1}));const o=document.createElement("div");o.setAttribute("id","note_section_"+this.bookID),this.book.noteSection=o,i=document.createElement(n),i.textContent=e,o.appendChild(i);const s="zh-TW"==t?"延伸閱讀":"Further Reading";let r=$(this.book.contents).find(`:header:contains(${s})`)[0];r?r.insertAdjacentElement("beforebegin",o):$(this.book.contents).append(o)}).call(this),function(t){$(t).each(((t,e)=>{const n=e.parentElement,i=document.createElement("P");let o,s,r,a,l=!1,h=0;const c=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,(t=>t.compareDocumentPosition(e)===Node.DOCUMENT_POSITION_PRECEDING?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT));for(;c.nextNode();)if((c.currentNode.textContent.includes("(")||c.currentNode.textContent.includes("（"))&&(l?h++:(o=c.currentNode,s=-1===c.currentNode.textContent.indexOf("(")?c.currentNode.textContent.indexOf("（"):c.currentNode.textContent.indexOf("("),l=!0)),l&&c.currentNode.textContent.includes(")")||c.currentNode.textContent.includes("）")){if(!h){r=c.currentNode,a=-1===c.currentNode.textContent.indexOf(")")?c.currentNode.textContent.indexOf("）")+1:c.currentNode.textContent.indexOf(")")+1;break}h--}if(o&&r){let t=Book.rangeTool.createRange(o,r,s,a);try{t.surroundContents(i)}catch(e){const n=t.extractContents();i.appendChild(n),t.insertNode(i)}i.textContent=i.textContent.trim().slice(1,-1)}i.insertAdjacentHTML("afterbegin",`<b>${e.textContent.trim().slice(1,-1)}、</b>`),this.book.notes.push(i),this.book.noteSection.append(i)}))}.call(this,n),o.call(this,$(this.book.notes));function o(t){t.each(((t,e)=>{e.id=`note_${t+1}_${this.bookID}`,e.classList.add("noteExplain");const n=document.createElement("SPAN");n.id=`checkNotedTextBtn_${t+1}_${this.bookID}`,n.classList.add("checkNotedTextBtn"),n.classList.add("bookUI"),n.innerHTML="⤴️",e.append(n)}))}},checkNotedText(t){const e=t.target.closest("[class*='checkNotedTextBtn']"),n=e.id.slice(e.id.indexOf("_")+1,e.id.lastIndexOf("_")),i=document.getElementById("noteButton_"+n+"_"+this.bookID),o=document.getElementById("notedText_"+n+"_"+this.bookID);"scroll"===this.book.mode?(window.location.href="#"+o.id,window.scrollBy(0,-window.innerHeight/2),o.classList.add("noted_text")):(this.book.currentPage=this.book.getPageNumByItem(i),this.book.hint(o))},displayNote(t){this.book.ignoreMutation=1;const e=t.target.closest("i[class*='noteButton']"),n=this.noteWindow,i=e.id.slice(e.id.indexOf("_")+1,e.id.lastIndexOf("_")),o=this.book.notes[i-1],s=o.cloneNode(!0),r=this.book.container.querySelector(`#notedText_${i}_${this.bookID}`);o.parentNode.replaceChild(s,o),this.keptNote=o,n.noteNumber.innerHTML=o.querySelector("b").textContent.slice(0,-1),o.removedTitle=o.removeChild(o.querySelector("b")),o.removedBtn=o.removeChild(o.querySelector(".checkNotedTextBtn")),o.querySelectorAll("support").forEach((t=>t.remove())),o.querySelectorAll("[class*='filler']").forEach((t=>t.remove())),o.querySelectorAll("[class*='small_filler']").forEach((t=>t.remove())),o.normalize(),n.noteContent.append(o),n.style.display="eink"===this.book.mode?"flex":"block",r.classList.remove("noted_text")},hideNoteWindow(){this.book.ignoreMutation=1,this.noteWindow.book.ignoreMutation=1,"eink"===this.noteWindow.book.mode&&(this.noteWindow.book.currentPage=1);const t=this.keptNote,e=Number(t.id.slice(t.id.indexOf("_")+1,t.id.lastIndexOf("_")));this.noteWindow.book.bookEditor.recoverAllEdits(),t.insertAdjacentElement("afterbegin",t.removedTitle),t.insertAdjacentElement("beforeend",t.removedBtn),t.normalize(),this.book.noteSection.replaceChild(t,this.book.noteSection.querySelectorAll("p")[e-1]),$(this.noteWindow).hide()}};static nodeTool={getTextNodeLineHeight(t){let e=document.createRange(),n=0;e.setStart(t,0);for(let i=1;!n;i+=2)e.setEnd(t,i),n=Math.round(e.getBoundingClientRect().height);return n},getNodeBound(t,e){const n="#text"===t.nodeName?Book.rangeTool.createRange(t,t,0,t.length).getBoundingClientRect():t.getBoundingClientRect();if(t.nodeStart="HTML"==e.nodeName?Math.round(n.y)+Math.round(e.scrollTop):Math.round(n.y)-Math.round(e.getBoundingClientRect().y)+Math.round(e.scrollTop),"#text"===t.nodeName){const e=Math.round(parseFloat($(t.parentElement).css("line-height"))),i=Book.nodeTool.getTextNodeLineHeight(t);t.nodeEnd=Math.round(t.nodeStart)+Math.round(n.height)+Math.round((e-i)/2)}else t.nodeEnd=Math.round(t.nodeStart)+Math.round(n.height)},getNodeWidth:t=>("#text"===t.nodeName?Book.rangeTool.createRange(t,t,0,t.length).getBoundingClientRect():t.getBoundingClientRect()).width,getTextRange(t,e){const n=document.createRange(),i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT);let o;for(;o=i.nextNode();){const t=o.textContent.indexOf(e);if(-1!==t)return n.setStart(o,t),n.setEnd(o,t+e.length),n}return null}};static rangeTool={getRangeBound(t,e){const{y:n,height:i}=t.getBoundingClientRect(),o="HTML"==e.nodeName?Math.round(e.scrollTop)+Math.round(n):Math.round(e.scrollTop)+(Math.round(n)-Math.round(e.getBoundingClientRect().y));return{rangeStart:o,rangeEnd:o+Math.round(i)}},createRange(t,e=t,n=0,i=1){const o=document.createRange();o.setStart(t,n<0?0:n);try{o.setEnd(e,i)}catch(t){o.setEnd(e,"#text"===e.nodeName?e.length:e.childNodes.length)}return o}}}Book.prototype.bookConfig={contents:void 0,einkStyle:"",bookTitle:void 0,author:"",upperMargin:30,lowerMargin:30,leftMargin:30,rightMargin:30,fullScreen:!0,zIndex:1e3,minImgHeight:200,pagingMethod:"column",useContentTable:!0,useNotes:!0,lang:void 0};class BookEditor{book=void 0;_changedElems=[];constructor(t){this.book=t}toCamelCase(t){return t.split("-").reduce(((t,e)=>t+e.slice(0,1).toUpperCase()+e.slice(1)))}static handleMediaCrossPage(t){return e=>{const n=e.book,i=n.pageHeight-2*n.margin,o=e.target,s=o.clientHeight-t.clientHeight,r=e.minimalPictureSize+s;if(e.spaceLeftOnThePage>=r||Math.abs(e.spaceLeftOnThePage-i)<=3)return n.bookEditor.changeStyle(t,{height:e.spaceLeftOnThePage-s+"px",width:(e.spaceLeftOnThePage-s)/t.clientHeight*t.clientWidth+"px"},!1),n._uniformizeMediaOnPage(o,e.edittingPageEnd),e.index-1;return null===n.bookEditor.addFiller(o,e.spaceLeftOnThePage+2*n.margin)&&(this.book.failCount++,content.parentElement.classList.add("Failed_"+this.book.failCount)),e.index}}changeStyle(t,e,n=!1){if("object"!=typeof e)throw new TypeError("Argument styleRules should be a style Object!");return(t="clientWidth"in t?[t]:t).forEach((t=>{if("string"==typeof t){for(const n in e)$(t).css(n,e[n]);this._changedElems.push({cssSelector:t,initStyles:e})}else{if("object"!=typeof t)throw new TypeError("Target elem should be a DOM Element or a CSS selector(String)!");{let i=this._changedElems.find((e=>e===t)),o="initStyles_"+this.book.instanceID;if(i)for(const n in e)i[o].hasOwnProperty(n)||(i[o][n]=t.style[this.toCamelCase(n)]),t.style[this.toCamelCase(n)]=e[n];else{t.isNewElem=n,t[o]||(t[o]={});for(const n in e)t[o][n]=t.style[this.toCamelCase(n)],t.style[this.toCamelCase(n)]=e[n];this._changedElems.push(t)}}}})),1===t.length?t[0]:t}getStylesheetPropertyValue(t,e){const n=this.getAllSelectors(t);for(const t of n)for(let n=0;n<document.styleSheets.length;n++){let i,o=document.styleSheets[n];try{i=o.cssRules||o.rules}catch(t){continue}for(let n=0;n<i.length;n++){let o=i[n];if(o.selectorText&&o.selectorText.split(",").some((e=>e.trim()===t)))return o.style.getPropertyValue(e)}}return null}getAllSelectors(t){const e=[];function n(t){return t.join(" ")}function i(t){const e=[];if(e.push(t.tagName.toLowerCase()),t.id&&e.push(`#${t.id}`),t.className){t.className.split(/\s+/).forEach((t=>e.push(`.${t}`)))}const n=Array.from(t.parentNode.children).indexOf(t)+1;return e.push(`:nth-child(${n})`),e}const o=function(t){const e=[];for(;t&&t!==document;)e.unshift(t),t=t.parentNode;return e}(t);for(let t=o.length-1;t>=0;t--){const s=o.slice(t).map(i),r=[[]];for(const t of s){const e=r.length;for(let n=0;n<e;n++){const e=r.shift();for(const n of t)r.push([...e,n])}}e.push(...r.map(n))}return[...new Set(e)]}recoverAllEdits(){this._changedElems.forEach((t=>{if(t)if(t.cssSelector)for(const e in t.initStyles)$(t.cssSelector).css(e,"");else if(t.isNewElem)"SUPPORT"===t.nodeName?this.removeSupport(t):t.remove();else{let e="initStyles_"+this.book.instanceID;for(const n in t[e])t.style[this.toCamelCase(n)]=t[e][n];delete t[e],delete t.isNewElem}})),this._changedElems=[],this.book.contents.normalize()}increaseSpaceByMargin(t,e){const n=Math.round(getComputedStyle(t).getPropertyValue("margin-top").slice(0,-2));if(t.previousElementSibling){const i=Math.round(getComputedStyle(t.previousElementSibling).getPropertyValue("margin-bottom").slice(0,-2));if(i>n)return void this.changeStyle(t,{"margin-top":i+e+"px"})}this.changeStyle(t,{"margin-top":n+e+"px"}),"inline"===$(t).css("display")&&this.changeStyle(t,{display:"inline-block"})}addFiller(t,e,n="filler",i="beforebegin"){let o;if(t.previousElementSibling?.classList.contains(n))return o=t.previousElementSibling,o.failedCount?o.failedCount++:o.failedCount=1,o.failedCount<=5?(e=parseInt(o.style.height),e+=5,this.changeStyle(o,{height:e+"px"}),o.classList.add("modified"),o):(this.changeStyle(t.previousElementSibling,{border:"solid 1px red"}),null);o=document.createElement("div"),o.classList.add(n),this.changeStyle(o,{height:e+"px","margin-top":"0px","margin-bottom":"0px"},!0);let s=0;const r=parseInt(window.getComputedStyle(t).marginTop),a=t.previousElementSibling;if(a){const t=parseInt(window.getComputedStyle(a).marginBottom);s=Math.max(r,t)}else s=r;o.style.marginTop=s+"px",t.insertAdjacentElement(i,o);let l=o.nextElementSibling;for(;l;)this.changeStyle(l,{"margin-top":"0px"}),l=l.children[0];return o}insertSupport(t,e,n,i){const o=this.changeStyle(document.createElement("SUPPORT"),{height:n+"px",display:"inline-block","vertical-align":"top"},!0);o.classList.add(`support_${i}`);const s=Book.rangeTool.createRange(t,t,0,e);let r;return s.collapse(!1),s.surroundContents(o),t.parentElement.normalize(),"SUPPORT"===o.previousSibling?.nodeName?(r=o.previousSibling,o.remove(),o.failedCount?o.failedCount+=1:o.failedCount=1,o.failedCount<=5?(n=parseInt(o.style.height),n+=2,this.changeStyle(o,{height:n+"px"}),o.classList.add("modified"),r):(this.changeStyle(o.previousSibling,{border:"solid 1px red"}),null)):o}removeSupport(t){const e=t.parentElement,n=t.previousSibling,i=t.nextSibling;t.remove(),n&&n.nodeType===Node.TEXT_NODE&&i&&i.nodeType===Node.TEXT_NODE&&(n.textContent+=i.textContent,i.remove()),e?.normalize()}}